import{d as Ae,f as He,r as p,l as Oe,a7 as ze,R as qe,a5 as he,h as i,c,e as t,w as l,a as s,s as V,i as v,t as r,u,q as n,C as y,Z as S,_ as $,F as b,W as oe,v as Ke,$ as ue,bh as Pe,ap as ye,H as ke,ah as We,b6 as Ze,a_ as Ge,a$ as Je,b0 as Qe,b1 as Xe,a0 as Ye,U as el,aF as ll,E as al,bi as tl,V as sl,p as nl,g as ol}from"./index-0b74b7aa.js";/* empty css                  *//* empty css                   *//* empty css                  *//* empty css                  *//* empty css                    *//* empty css                     *//* empty css               *//* empty css                *//* empty css                 */import{T as ul,_ as rl,a as pl,b as il}from"./dark-82217916.js";import{b as dl}from"./module-ab3377c8.js";import{c as be,g as cl,e as vl,p as _l,u as fl,a as gl,b as we}from"./upgrade-8ffec438.js";import{_ as ml}from"./_plugin-vue_export-helper-c27b6911.js";const M=z=>(nl("data-v-32608dc5"),z=z(),ol(),z),xl={class:"text-lg"},hl={class:"font-bold px-[2px]"},yl=M(()=>s("span",null,"升级到",-1)),kl={class:"font-bold px-[2px]"},bl=M(()=>s("span",null,"版本",-1)),wl={class:"font-bold px-[2px]"},Cl=M(()=>s("span",null,"当前版本",-1)),El={class:"font-bold px-[2px]"},Tl=M(()=>s("span",null,[v("如需升级到最新版可在"),s("a",{class:"text-primary",href:"https://www.niucloud.com",target:"_blank"},"niucloud-admin官网"),v("购买相关服务后再进行升级")],-1)),Bl={key:1},Vl={class:"h-[400px]",style:{overflow:"auto"}},Ul={key:0,class:"flex flex-col"},Sl={key:0,class:"bg-[#fff] my-3"},$l={class:"px-[20px] pt-[10px] text-[14px] el-table"},Il={style:{height:"calc(300px)",overflow:"auto"}},Dl={key:0},Fl={key:1},Ml={key:0},Nl={key:1},jl={class:"h-[370px] mt-[30px]"},Ll={class:"flex flex-col"},Rl={class:"bg-[#fff] my-3"},Al={class:"p-[20px] mt-[50px] mx-[10px] border-[1px] border-[#E6E6E6] rounded-[10px]"},Hl={class:"flex justify-between items-center mt-[-9px]"},Ol={class:"text-[14px] text-[#374151] mb-[10px]"},zl={key:0,class:"p-[20px] mt-[20px] mx-[10px] border-[1px] border-[#E6E6E6] rounded-[10px]"},ql={class:"flex justify-between items-center mt-[-9px]"},Kl={class:"text-[14px] text-[#374151] mb-[10px]"},Pl={class:"text-[14px] text-[#9699B6]"},Wl={class:"mt-[20px] h-[370px]"},Zl=M(()=>s("img",{src:pl,alt:""},null,-1)),Gl={class:"mt-[20px]"},Jl=M(()=>s("img",{src:il,alt:""},null,-1)),Ql={class:"text-[16px] text-[#9699B6] mt-[10px]"},Xl={class:"mt-[20px]"},Yl={class:"dialog-footer"},ea=["innerHTML"],la={class:"flex justify-end"},aa=["innerHTML"],ta={class:"flex justify-end"},sa=Ae({__name:"index",emits:["complete","cloudbuild"],setup(z,{expose:Ce,emit:Ee}){const Te=He(),Be=p(Date.now()),k=p(!1),d=p(null),N=p(!0),x=p(null),_=p("upgrade"),E=p(1),j=p(null),w=p(!1),L=p(null),I=p(!1);let Q=[],X=[];const q=p(!1),K=p(30);let R=null;const D=p({is_need_backup:!0,is_need_cloudbuild:!0});p([{name:"备份源码",code:"backupCode"},{name:"备份数据库",code:"backupSql"}]);const P=p(!1),U=p(!1),Ve=p(null),Y=p(0);let T=null;const B=p(!1),ee=p(""),F=()=>{cl().then(({data:a})=>{if(a){if(!d.value){if(d.value=a.upgrade_content,!a.upgrade_content||!Array.isArray(a.upgrade_content.content))return;let e=0,f=0;for(let g=0;g<d.value.content.length;g++)d.value.content[g].version_list.length?e++:f++;d.value.content.length==e?N.value=!0:d.value.content.length==f&&(N.value=!1)}if(!k.value){Ue();return}if(x.value||(U.value=!0,L.value.execute("clear"),L.value.execute("开始升级"),P.value=!0,Ve.value=Date.now(),Y.value=0,T&&clearInterval(T),T=setInterval(()=>{Y.value++},1e3)),x.value=a,a.log.forEach(e=>{Q.includes(e)||(L.value.pushMessage({content:`${e}`}),Q.push(e))}),a.error&&(a.error.forEach(e=>{X.includes(e)||(L.value.pushMessage({content:e,class:"error"}),X.push(e),ee.value=e)}),B.value=!0,U.value=!1,T&&(clearInterval(T),T=null),P.value=!1),a.step=="restoreComplete"){H&&clearInterval(H);return}if(a.step=="upgradeComplete"){_.value="complete",U.value=!1,C.value=4,A&&A.close(),Ee("complete"),T&&(clearInterval(T),T=null),P.value=!1,be();return}C.value=2,_.value="upgrade",ie()}})};F();const le=p(!1),re=()=>{_.value="upgrade",le.value=!0,U.value=!0,B.value=!1},pe=Oe(()=>{const a=Y.value,e=Math.floor(a/3600),f=Math.floor(a%3600/60),g=a%60;return[e>0?`${e}小时`:"",f>0?`${f}分钟`:"",`${g}秒`].filter(Boolean).join("")}),ie=()=>{vl().then(()=>{F()}).catch(a=>{a.message.indexOf("队列")!=-1?(K.value=30,R=setInterval(()=>{K.value--,K.value==0&&G("retry")},1e3),q.value=!0):ue({message:a.message,type:"error"})})};let A=null;const Ue=()=>{A=Pe.success({title:n("warning"),dangerouslyUseHTMLString:!0,message:ye("div",{},[n("upgrade.upgradingTips"),ye("span",{class:"text-primary cursor-pointer",onClick:Se},[n("upgrade.clickView")])]),duration:0,showClose:!1})},Se=()=>{k.value=!0,F(),E.value=2,C.value=3,_.value="upgrade",A&&A.close()},de=p("");ze().then(a=>{de.value=a.data.version.version});const ce=p("");dl().then(({data:a})=>{ce.value=a.last_version});const ae=p(!1),W=p(!1),Z=p(!1),ve=async()=>{var e,f;if(W.value)return;W.value=!0,Z.value=!0;const a=((e=d.value)==null?void 0:e.upgrade_apps.join(","))!="niucloud-admin"?(f=d.value)==null?void 0:f.upgrade_apps.join(","):"";await _l(a).then(async({data:g})=>{j.value=g,ae.value=g.is_pass,_.value="upgrade",x.value?C.value:C.value=0,I.value=!1,k.value=!0,W.value=!1,Z.value=!1}).catch(()=>{W.value=!1,Z.value=!1})},$e=()=>{var e,f;if(!ae.value||w.value)return;w.value=!0;const a=((e=d.value)==null?void 0:e.upgrade_apps.join(","))!="niucloud-admin"?(f=d.value)==null?void 0:f.upgrade_apps.join(","):"";fl(a,D.value).then(()=>{F()}).catch(()=>{w.value=!1})},Ie=(a="",e=null)=>{if(B.value=!1,x.value)ue({message:"已有正在执行中的升级任务",type:"error"}),k.value=!0,E.value=2,C.value=3,_.value="upgrade",e&&e();else{if(a&&de.value!=ce.value){ue({message:"存在新版本框架，请先升级框架",type:"error"}),e&&e();return}if(w.value)return;w.value=!0,gl(a).then(({data:f})=>{w.value=!1,d.value=f;let g=0,O=0;for(let h=0;h<d.value.content.length;h++)d.value.content[h].version_list.length?g++:O++;d.value.content.length==g?N.value=!0:d.value.content.length==O&&(N.value=!1),ke.get("upgradeTipsLock")?ve():I.value=!0,e&&e()}).catch(()=>{w.value=!1,e&&e()})}};let H=null;const _e=new ul,De=(a,e,f,g,O)=>{if(e=="开始升级"){f(_e);const h=Fe(["/","——","\\","|"]);H=setInterval(()=>{_e.flush("> "+h.next().value)},150)}},Fe=a=>{let e=0;return{next(){return e+1==a.length&&(e=0),{value:a[e++]}}}},Me=a=>{_.value=="upgrade"&&x.value&&["upgradeComplete","restoreComplete"].includes(x.value.step)===!1&&!le.value?We.confirm(n("upgrade.showDialogCloseTips"),n("warning"),{confirmButtonText:n("confirm"),cancelButtonText:n("cancel"),type:"warning"}).then(()=>{a()}):a()};qe(()=>k.value,()=>{k.value||Ne()});const Ne=()=>{_.value="upgrade",w.value=!1,x.value=null,le.value=!1,B.value=!1,ee.value="",U.value=!1,Q=[],X=[],C.value=0,H&&clearInterval(H),R&&clearInterval(R),D.value={is_need_backup:!0,is_need_cloudbuild:!0},E.value=1,be().then(()=>{})},G=a=>{switch(q.value=!1,a){case"local":we(a).then(()=>{F()});break;case"retry":ie(),R&&clearInterval(R);break;case"rollback":we(a).then(()=>{F()});break}},je=(a=!1)=>{a&&ke.set({key:"upgradeTipsLock",data:a}),I.value=!1,!a&&(k.value=!0)};p(0);const C=p(0),Le=()=>{const a=Te.resolve({path:"/tools/backup_records"});window.open(a.href,"_blank")};return Ce({open:Ie,loading:w}),(a,e)=>{const f=Ze,g=Ge,O=Je,h=Qe,te=Xe,fe=he("Select"),J=Ye,ge=he("CloseBold"),se=el,me=ll,m=al,xe=tl,ne=sl;return i(),c(b,null,[t(ne,{modelValue:k.value,"onUpdate:modelValue":e[11]||(e[11]=o=>k.value=o),title:u(n)("upgrade.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":Me},{footer:l(()=>[s("div",Yl,[E.value==1&&d.value.content.length&&N.value?(i(),V(m,{key:0,onClick:e[6]||(e[6]=o=>E.value=2),type:"primary"},{default:l(()=>[v(r(u(n)("upgrade.upgradeButton")),1)]),_:1})):y("",!0),S(t(m,{type:"primary",loading:P.value,class:"!w-[140px]"},{default:l(()=>[v("已用时 "+r(u(pe)),1)]),_:1},8,["loading"]),[[$,E.value==2&&U.value&&x.value&&!B.value]]),E.value==2&&_.value!="complete"?(i(),c(b,{key:1},[_.value=="upgrade"&&!x.value?(i(),V(m,{key:0,type:"primary",disabled:!ae.value,onClick:e[7]||(e[7]=()=>{_.value="backup",C.value=1})},{default:l(()=>[v(r(u(n)("nextStep")),1)]),_:1},8,["disabled"])):y("",!0),_.value=="backup"?(i(),V(m,{key:1,onClick:e[8]||(e[8]=()=>{_.value="upgrade",C.value=1})},{default:l(()=>[v(r(u(n)("prev")),1)]),_:1})):y("",!0),_.value=="backup"?(i(),V(m,{key:2,type:"primary",loading:w.value,onClick:e[9]||(e[9]=()=>{$e()})},{default:l(()=>[v(r(u(n)("nextStep")),1)]),_:1},8,["loading"])):y("",!0),_.value=="complete"?(i(),V(m,{key:3,onClick:e[10]||(e[10]=o=>k.value=!1)},{default:l(()=>[v(r(u(n)("complete")),1)]),_:1})):y("",!0)],64)):y("",!0)])]),default:l(()=>[d.value?(i(),c(b,{key:0},[E.value==1?(i(!0),c(b,{key:0},oe(d.value.content,(o,Re)=>(i(),c(b,null,[s("div",xl,[o.upgrade_version?(i(),c(b,{key:0},[s("span",null,"【"+r(o.app.app_name)+"】本次升级将从",1),s("span",hl,r(o.version),1),yl,s("span",kl,r(o.upgrade_version),1),bl],64)):(i(),c(b,{key:1},[d.value.content.length>1?(i(),c(b,{key:0},[s("span",null,"【"+r(o.app.app_name)+"】当前版本",1),s("span",wl,r(o.version),1)],64)):(i(),c(b,{key:1},[Cl,s("span",El,r(o.version),1)],64))],64))]),o.upgrade_version!=o.last_version?(i(),c("div",{key:0,class:Ke(["mt-[10px]",{"mb-[10px]":Re+1<d.value.content.length}])},[t(f,{type:"info","show-icon":"",closable:!1},{title:l(()=>[s("span",null,"当前最新版本为"+r(o.last_version)+"，您的服务"+r(o.expire_time?`已于${o.expire_time}到期`:"长期有效")+"。",1),Tl]),_:2},1024)],2)):y("",!0)],64))),256)):y("",!0),E.value==2?(i(),c("div",Bl,[!B.value&&_.value!="complete"?(i(),V(O,{key:0,active:C.value,"align-center":"",class:"number-of-steps","process-status":"process"},{default:l(()=>[t(g,{title:u(n)("testDirectoryPermissions")},null,8,["title"]),t(g,{title:u(n)("upgrade.option")},null,8,["title"]),t(g,{title:u(n)("startUpgrade")},null,8,["title"]),t(g,{title:u(n)("upgradeEnd")},null,8,["title"])]),_:1},8,["active"])):y("",!0),s("div",Vl,[S(s("div",null,[j.value&&!x.value?(i(),c("div",Ul,[t(se,null,{default:l(()=>[j.value.dir?(i(),c("div",Sl,[s("div",$l,[t(te,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[t(h,{span:18},{default:l(()=>[s("span",null,r(u(n)("upgrade.path")),1)]),_:1}),t(h,{span:3},{default:l(()=>[s("span",null,r(u(n)("upgrade.demand")),1)]),_:1}),t(h,{span:3},{default:l(()=>[s("span",null,r(u(n)("status")),1)]),_:1})]),_:1}),s("div",Il,[(i(!0),c(b,null,oe(j.value.dir.is_readable,o=>(i(),V(te,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[t(h,{span:18},{default:l(()=>[s("span",null,r(o.dir),1)]),_:2},1024),t(h,{span:3},{default:l(()=>[s("span",null,r(u(n)("upgrade.readable")),1)]),_:1}),t(h,{span:3},{default:l(()=>[o.status?(i(),c("span",Dl,[t(J,{color:"green"},{default:l(()=>[t(fe)]),_:1})])):(i(),c("span",Fl,[t(J,{color:"red"},{default:l(()=>[t(ge)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(i(!0),c(b,null,oe(j.value.dir.is_write,o=>(i(),V(te,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[t(h,{span:18},{default:l(()=>[s("span",null,r(o.dir),1)]),_:2},1024),t(h,{span:3},{default:l(()=>[s("span",null,r(u(n)("upgrade.write")),1)]),_:1}),t(h,{span:3},{default:l(()=>[o.status?(i(),c("span",Ml,[t(J,{color:"green"},{default:l(()=>[t(fe)]),_:1})])):(i(),c("span",Nl,[t(J,{color:"red"},{default:l(()=>[t(ge)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])])):y("",!0)]),_:1})])):y("",!0),S(s("div",jl,[t(u(rl),{ref_key:"terminalRef",ref:L,name:`upgrade-${Be.value}`,context:x.value?x.value.upgrade.app_key:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:De},null,8,["name","context"])],512),[[$,U.value&&x.value&&!B.value]])],512),[[$,_.value=="upgrade"]]),S(s("div",Ll,[t(se,null,{default:l(()=>[s("div",Rl,[s("div",Al,[s("div",Hl,[t(me,{modelValue:D.value.is_need_cloudbuild,"onUpdate:modelValue":e[0]||(e[0]=o=>D.value.is_need_cloudbuild=o),label:u(n)("upgrade.isNeedCloudbuild"),"true-value":!0,"false-value":!1,size:"large"},null,8,["modelValue","label"])]),s("div",Ol,r(u(n)("upgrade.cloudbuildTips")),1)]),d.value.last_backup?(i(),c("div",zl,[s("div",ql,[t(me,{modelValue:D.value.is_need_backup,"onUpdate:modelValue":e[1]||(e[1]=o=>D.value.is_need_backup=o),label:u(n)("upgrade.isNeedBackup"),"true-value":!0,"false-value":!1,size:"large"},null,8,["modelValue","label"]),t(m,{link:"",type:"primary",class:"!text-[#9699B6]",onClick:Le},{default:l(()=>[v(r(u(n)("upgrade.isNeedBackupBtn")),1)]),_:1})]),s("div",Kl,r(u(n)("upgrade.isNeedBackupTips")),1),s("div",Pl,r(u(n)("上次备份时间："))+r(d.value.last_backup.complete_time),1)])):y("",!0)])]),_:1})],512),[[$,_.value=="backup"]]),S(s("div",Wl,[t(xe,{icon:"error",title:u(n)("升级失败")},{icon:l(()=>[Zl]),extra:l(()=>[t(se,{class:"max-h-[120px] !overflow-auto text-[15px] text-[#4F516D] mb-[15px] mt-[-15px]"},{default:l(()=>[v(r(ee.value),1)]),_:1}),t(m,{onClick:e[2]||(e[2]=o=>re()),class:"!w-[90px]"},{default:l(()=>[v("错误信息")]),_:1}),t(m,{onClick:e[3]||(e[3]=o=>k.value=!1),type:"primary",class:"!w-[90px]"},{default:l(()=>[v("完成")]),_:1})]),_:1},8,["title"])],512),[[$,B.value]]),S(s("div",Gl,[t(xe,{icon:"success",title:u(n)("upgrade.upgradeSuccess")},{icon:l(()=>[Jl]),extra:l(()=>[S(s("div",{class:"text-[16px] text-[#4F516D] mt-[-5px]"},r(u(n)("upgrade.upgradeCompleteTips")),513),[[$,x.value&&x.value.executed&&!x.value.executed.includes("cloudBuild")]]),s("div",Ql,"本次升级用时"+r(u(pe)),1),s("div",Xl,[t(m,{onClick:e[4]||(e[4]=o=>re()),class:"!w-[90px]"},{default:l(()=>[v("返回")]),_:1}),t(m,{onClick:e[5]||(e[5]=o=>k.value=!1),type:"primary",class:"!w-[90px]"},{default:l(()=>[v("完成")]),_:1})])]),_:1},8,["title"])],512),[[$,_.value=="complete"]])])])):y("",!0)],64)):y("",!0)]),_:1},8,["modelValue","title"]),t(ne,{modelValue:I.value,"onUpdate:modelValue":e[15]||(e[15]=o=>I.value=o),title:u(n)("warning"),width:"500px",draggable:""},{footer:l(()=>[s("div",la,[t(m,{onClick:e[12]||(e[12]=o=>je(!0)),type:"primary"},{default:l(()=>[v(r(u(n)("upgrade.knownToKnow")),1)]),_:1}),t(m,{onClick:e[13]||(e[13]=o=>ve()),type:"primary",plain:"",loading:Z.value},{default:l(()=>[v(r(u(n)("upgrade.upgradeButton")),1)]),_:1},8,["loading"]),t(m,{onClick:e[14]||(e[14]=o=>I.value=!1)},{default:l(()=>[v(r(u(n)("cancel")),1)]),_:1})])]),default:l(()=>[s("span",{innerHTML:u(n)("upgrade.upgradeTips")},null,8,ea)]),_:1},8,["modelValue","title"]),t(ne,{modelValue:q.value,"onUpdate:modelValue":e[19]||(e[19]=o=>q.value=o),title:u(n)("warning"),width:"500px",draggable:"","show-close":!1},{footer:l(()=>[s("div",ta,[t(m,{onClick:e[16]||(e[16]=o=>G("local")),type:"primary"},{default:l(()=>[v(r(u(n)("upgrade.localBuild")),1)]),_:1}),t(m,{onClick:e[17]||(e[17]=o=>G("retry")),type:"primary"},{default:l(()=>[v(r(u(n)("upgrade.cloudBuild"))+"（"+r(K.value)+"S）",1)]),_:1}),t(m,{onClick:e[18]||(e[18]=o=>G("rollback")),type:"primary"},{default:l(()=>[v(r(u(n)("upgrade.rollback")),1)]),_:1})])]),default:l(()=>[s("span",{innerHTML:u(n)("upgrade.cloudBuildErrorTips")},null,8,aa)]),_:1},8,["modelValue","title"])],64)}}});const ha=ml(sa,[["__scopeId","data-v-32608dc5"]]);export{ha as default};
