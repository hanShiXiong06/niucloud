import{d as de,f as ce,y as ue,r as m,l as T,aZ as me,h as v,c as y,a,e as o,w as i,i as c,t as h,u,s as Z,C as ve,F as P,W as z,dA as pe,dB as _e,d4 as fe,$ as d,ax as ye,E as he,dm as xe,as as ge,L as be,a0 as we,M as ke,b7 as Te,N as Ee,V as Ve,p as Xe,g as Ce}from"./index-0b74b7aa.js";/* empty css                  *//* empty css                   *//* empty css                *//* empty css                  */import"./el-form-item-4ed993c7.js";/* empty css                 *//* empty css               *//* empty css                   *//* empty css                  */import{g as Me,a as Le,e as Ie,b as Se,p as Ne,t as Be}from"./printer_template-70ba2c3b.js";import{_ as $e}from"./_plugin-vue_export-helper-c27b6911.js";const w=X=>(Xe("data-v-d6a3476f"),X=X(),Ce(),X),De={class:"xml-editor-container"},Pe={class:"editor-toolbar bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between"},ze={class:"flex items-center space-x-4"},Ae={class:"text-lg font-medium"},Ue={class:"flex items-center space-x-2"},Fe={class:"editor-content flex h-full"},Ge={class:"editor-main flex-1 p-4 overflow-y-auto"},Re={class:"template-info bg-white rounded-lg border border-gray-200 p-4 mb-4"},Ze=w(()=>a("h3",{class:"text-sm font-medium text-gray-700 mb-3"},"模板信息",-1)),qe={class:"grid grid-cols-2 gap-4"},Oe=w(()=>a("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"模板名称",-1)),He={class:"col-span-2"},je=w(()=>a("label",{class:"block text-xs font-medium text-gray-700 mb-1"},"模板描述",-1)),Qe={class:"xml-editor bg-white rounded-lg border border-gray-200 p-4"},We={class:"flex items-center justify-between mb-3"},Je=w(()=>a("label",{class:"block text-sm font-medium text-gray-700"},"XML模板内容",-1)),Ke={class:"text-xs text-gray-500"},Ye={class:"relative"},et={class:"line-numbers absolute left-2 top-2 text-xs text-gray-400 pointer-events-none select-none"},tt={class:"quick-insert mt-4"},at=w(()=>a("div",{class:"text-sm font-medium text-gray-700 mb-2"},"快速插入变量",-1)),lt={class:"flex flex-wrap gap-2"},ot={class:"editor-sidebar w-80 bg-gray-50 border-l border-gray-200 p-4 overflow-y-auto"},st={class:"preview-section mb-6"},rt={class:"text-sm font-medium text-gray-700 mb-2 flex items-center"},nt={class:"preview-content bg-white border border-gray-200 rounded p-4 text-xs font-mono"},it={key:0,class:"whitespace-pre-wrap text-gray-800"},dt={key:1,class:"text-gray-400 text-center py-8"},ct={class:"help-section"},ut={class:"text-sm font-medium text-gray-700 mb-2 flex items-center"},mt={class:"help-content bg-white border border-gray-200 rounded p-4 text-xs space-y-3"},vt=w(()=>a("div",{class:"font-medium text-gray-800 mb-1"},"基本结构:",-1)),pt=["innerHTML"],_t=w(()=>a("div",{class:"font-medium text-gray-800 mb-1"},"可用变量:",-1)),ft={class:"space-y-1"},yt=fe('<div data-v-d6a3476f><div class="font-medium text-gray-800 mb-1" data-v-d6a3476f>标签说明:</div><div class="space-y-1 text-gray-600" data-v-d6a3476f><div data-v-d6a3476f><code data-v-d6a3476f>SIZE</code> - 纸张尺寸(宽,高)mm</div><div data-v-d6a3476f><code data-v-d6a3476f>TEXT</code> - 文本元素，属性：x,y,w,h,r</div><div data-v-d6a3476f><code data-v-d6a3476f>BC128</code> - 条形码，属性：x,y,h,s,n,w,r</div><div data-v-d6a3476f><code data-v-d6a3476f>QR</code> - 二维码，属性：x,y,w,h,r</div></div></div><div data-v-d6a3476f><div class="font-medium text-gray-800 mb-1" data-v-d6a3476f>属性说明:</div><div class="space-y-1 text-gray-600 text-xs" data-v-d6a3476f><div data-v-d6a3476f><code data-v-d6a3476f>x,y</code> - 位置坐标(像素)</div><div data-v-d6a3476f><code data-v-d6a3476f>w,h</code> - 宽度高度倍数</div><div data-v-d6a3476f><code data-v-d6a3476f>r</code> - 旋转角度(0,90,180,270)</div><div data-v-d6a3476f><code data-v-d6a3476f>s</code> - 条码宽度倍数</div><div data-v-d6a3476f><code data-v-d6a3476f>n</code> - 是否显示文字(0/1)</div></div></div>',2),ht={class:"preview-container bg-gray-100 p-4 rounded"},xt=["innerHTML"],gt={key:1,class:"text-center text-gray-500 py-8"},bt=de({__name:"editor",setup(X){const A=ce(),q=ue(),s=m(""),C=m(!1),S=m(!1),N=m(!1),x=m(q.params.id||""),g=T(()=>!!x.value&&x.value!=="new"),B=T(()=>!x.value||x.value==="new"),E=m(!1),$=m(!1),M=m(""),r=m({template_name:"",template_type:"device_label",description:"",is_default:!1,content:""}),O=m([{label:"回收订单",value:"recycle_order"},{label:"设备标签",value:"device_label"},{label:"检测报告",value:"check_report"}]),U=T(()=>s.value.split(`
`).length),H=T(()=>s.value.length),F=T(()=>{if(!s.value.trim())return"";try{return L(s.value)}catch{return s.value}}),j=T(()=>`&lt;PAGE&gt;<br/>
&nbsp;&nbsp;&lt;SIZE&gt;58,40&lt;/SIZE&gt;<br/>
&nbsp;&nbsp;&lt;TEXT x="4" y="12"&gt;{{变量}}&lt;/TEXT&gt;<br/>
&lt;/PAGE&gt;`),Q=m([{key:"device_id",label:"设备ID"},{key:"model",label:"设备型号"},{key:"imei",label:"IMEI",isBarcode:!0},{key:"order_no",label:"订单号"},{key:"price_staff_name",label:"询价员"},{key:"check_date",label:"检测日期"},{key:"check_staff",label:"检测员"},{key:"check_result",label:"检测结果"},{key:"total_price",label:"总价格"},{key:"create_time",label:"创建时间"}]),W=m([{key:"device_id",description:"设备ID编号"},{key:"model",description:"设备型号"},{key:"imei",description:"IMEI串号"},{key:"order_no",description:"订单编号"},{key:"price_staff_name",description:"询价员姓名"},{key:"check_date",description:"检测日期"},{key:"check_staff",description:"检测员姓名"},{key:"check_result",description:"检测结果"},{key:"total_price",description:"总价格"},{key:"create_time",description:"创建时间"}]),D=`<PAGE>
  <SIZE>58,40</SIZE>
  <TEXT x="4" y="12" w="1" h="1" r="0">{{device_id}}</TEXT>
  <TEXT x="4" y="36" w="1" h="1" r="0">{{model}}</TEXT>
  <TEXT x="4" y="60" w="1" h="1" r="0">{{check_date}}</TEXT>
  <TEXT x="4" y="84" w="1" h="1" r="0">{{check_staff}}</TEXT>
  <BC128 x="4" y="108" h="32" s="1" n="1" w="2" r="0">{{imei}}</BC128>
  <TEXT x="4" y="156" w="1" h="1" r="0">{{check_result}}</TEXT>
</PAGE>`,J=()=>{A.go(-1)},K=()=>{r.value.content=s.value},Y=()=>{if(s.value.trim())try{s.value=L(s.value)}catch{}},ee=()=>{try{s.value=L(s.value),d.success("XML格式化成功")}catch{d.error("XML格式化失败，请检查语法")}},L=t=>{if(!t.trim())return t;try{const n=new DOMParser().parseFromString(t,"text/xml");if(n.documentElement.nodeName==="parsererror")throw new Error("XML语法错误");return G(n.documentElement,0)}catch(e){throw e}},G=(t,e)=>{var _;const n="  ".repeat(e);let p=`${n}<${t.nodeName}`;for(let f=0;f<t.attributes.length;f++){const I=t.attributes[f];p+=` ${I.name}="${I.value}"`}const k=((_=t.textContent)==null?void 0:_.trim())||"";if(t.children.length===0&&k)p+=`>${k}</${t.nodeName}>`;else if(t.children.length===0)p+="/>";else{p+=`>
`;for(let f=0;f<t.children.length;f++)p+=G(t.children[f],e+1)+`
`;p+=`${n}</${t.nodeName}>`}return p},V=()=>{if(!s.value.trim())return d.warning("请输入XML内容"),!1;try{const e=new DOMParser().parseFromString(s.value,"text/xml");if(e.documentElement.nodeName==="parsererror")throw new Error("XML语法错误");if(e.documentElement.nodeName!=="PAGE")throw new Error("根元素必须是PAGE");return d.success("XML验证通过"),!0}catch(t){return d.error("XML验证失败: "+t.message),!1}},te=t=>{const e=document.querySelector(".xml-textarea textarea");if(!e)return;const n=e.selectionStart,p=e.selectionEnd,k=s.value.substring(0,n),b=s.value.substring(p);let _="";t.isBarcode?_=`<BC128 x="4" y="12" h="32" s="1" n="1" w="2" r="0">{{${t.key}}}</BC128>`:_=`<TEXT x="4" y="12" w="1" h="1" r="0">{{${t.key}}}</TEXT>`,s.value=k+_+b,ye(()=>{e.focus(),e.setSelectionRange(n+_.length,n+_.length)})},ae=async()=>{if(g.value)try{const e=(await Me(Number(x.value))).data;r.value={template_name:e.template_name||"",template_type:e.template_type||"device_label",description:e.description||"",is_default:e.is_default||!1,content:e.content||""},s.value=e.content||D,d.success("模板加载成功")}catch(t){d.error("模板加载失败"),console.error("Load template error:",t)}},le=async()=>{try{const t=await Le();t.data&&Array.isArray(t.data)&&(O.value=t.data)}catch(t){console.error("Load template types error:",t)}},oe=()=>{V()&&(r.value.content=s.value,E.value=!0)},se=async()=>{var t;if(!r.value.template_name){d.warning("请输入模板名称");return}if(!r.value.template_type){d.warning("请选择模板类型");return}if(!s.value.trim()){d.warning("请输入模板内容");return}if(V())try{C.value=!0,r.value.content=s.value;let e;g.value?e=await Ie(Number(x.value),r.value):e=await Se(r.value),d.success("模板保存成功"),E.value=!1,B.value&&((t=e.data)!=null&&t.id)&&A.replace(`/addon/recycle/printer_template/editor/${e.data.id}`)}catch(e){d.error("模板保存失败"),console.error("Save template error:",e)}finally{C.value=!1}},re=async()=>{if(V())try{if(S.value=!0,g.value){const t=await Ne(Number(x.value));M.value=t.data||""}else M.value=`<div class="template-preview">${L(s.value)}</div>`;$.value=!0}catch(t){d.error("预览失败"),console.error("Preview error:",t)}finally{S.value=!1}},ne=async()=>{if(!g.value){d.warning("请先保存模板再进行测试打印");return}if(V())try{N.value=!0;const t={device_id:"TEST001",model:"测试设备",imei:"123456789012345",order_no:"ORDER001",price_staff_name:"测试员",check_date:"2024-01-01",check_staff:"检测员",check_result:"良好",total_price:"1000.00",create_time:"2024-01-01 12:00:00"};await Be(Number(x.value),t),d.success("测试打印已发送到打印机")}catch(t){d.error("测试打印失败"),console.error("Test print error:",t)}finally{N.value=!1}};return me(async()=>{await le(),g.value?await ae():(s.value=D,r.value.content=D)}),(t,e)=>{const n=he,p=xe,k=ge,b=be,_=we,f=ke,I=Te,ie=Ee,R=Ve;return v(),y("div",De,[a("div",Pe,[a("div",ze,[o(n,{onClick:J,icon:"ArrowLeft",size:"small"},{default:i(()=>[c(" 返回 ")]),_:1}),o(p,{direction:"vertical"}),a("h2",Ae,h(u(g)?"编辑模板":"新建模板"),1),r.value.template_name?(v(),Z(k,{key:0,type:"info",size:"small"},{default:i(()=>[c(h(r.value.template_name),1)]),_:1})):ve("",!0)]),a("div",Ue,[o(n,{onClick:ee,icon:"Promotion",size:"small"},{default:i(()=>[c(" 格式化XML ")]),_:1}),o(n,{onClick:V,icon:"CircleCheck",size:"small",type:"info"},{default:i(()=>[c(" 验证XML ")]),_:1}),o(n,{onClick:re,icon:"View",size:"small",loading:S.value},{default:i(()=>[c(" 预览 ")]),_:1},8,["loading"]),o(n,{onClick:ne,icon:"Printer",size:"small",type:"warning",loading:N.value},{default:i(()=>[c(" 测试打印 ")]),_:1},8,["loading"]),o(n,{onClick:oe,icon:"Document",size:"small",type:"primary",loading:C.value},{default:i(()=>[c(" 保存模板 ")]),_:1},8,["loading"])])]),a("div",Fe,[a("div",Ge,[a("div",Re,[Ze,a("div",qe,[a("div",null,[Oe,o(b,{modelValue:r.value.template_name,"onUpdate:modelValue":e[0]||(e[0]=l=>r.value.template_name=l),placeholder:"请输入模板名称",size:"small",disabled:!u(g)&&!u(B)},null,8,["modelValue","disabled"])]),a("div",He,[je,o(b,{modelValue:r.value.description,"onUpdate:modelValue":e[1]||(e[1]=l=>r.value.description=l),type:"textarea",rows:2,placeholder:"请输入模板描述",size:"small",disabled:!u(g)&&!u(B)},null,8,["modelValue","disabled"])])])]),a("div",Qe,[a("div",We,[Je,a("div",Ke," 行数: "+h(u(U))+" | 字符数: "+h(u(H)),1)]),a("div",Ye,[o(b,{modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=l=>s.value=l),type:"textarea",rows:20,placeholder:"请输入XML模板内容...",class:"xml-textarea",onInput:K,onBlur:Y},null,8,["modelValue"]),a("div",et,[(v(!0),y(P,null,z(u(U),l=>(v(),y("div",{key:l,class:"line-number"},h(l),1))),128))])]),a("div",tt,[at,a("div",lt,[(v(!0),y(P,null,z(Q.value,l=>(v(),Z(n,{key:l.key,onClick:wt=>te(l),size:"small",plain:"",icon:l.isBarcode?"Printer":"Document"},{default:i(()=>[c(h(l.label),1)]),_:2},1032,["onClick","icon"]))),128))])])])]),a("div",ot,[a("div",st,[a("h3",rt,[o(_,{class:"mr-1"},{default:i(()=>[o(u(pe))]),_:1}),c(" 实时预览 ")]),a("div",nt,[u(F)?(v(),y("pre",it,h(u(F)),1)):(v(),y("div",dt,"输入XML内容后显示预览"))])]),a("div",ct,[a("h3",ut,[o(_,{class:"mr-1"},{default:i(()=>[o(u(_e))]),_:1}),c(" 语法帮助 ")]),a("div",mt,[a("div",null,[vt,a("div",{class:"block bg-gray-100 p-2 rounded text-xs",innerHTML:u(j)},null,8,pt)]),a("div",null,[_t,a("div",ft,[(v(!0),y(P,null,z(W.value,l=>(v(),y("div",{key:l.key,class:"text-gray-600"},[a("code",null,h(l.key),1),c(" - "+h(l.description),1)]))),128))])]),yt])])])]),o(R,{modelValue:E.value,"onUpdate:modelValue":e[7]||(e[7]=l=>E.value=l),title:"保存模板",width:"400px"},{footer:i(()=>[o(n,{onClick:e[6]||(e[6]=l=>E.value=!1)},{default:i(()=>[c("取消")]),_:1}),o(n,{type:"primary",onClick:se,loading:C.value},{default:i(()=>[c("保存")]),_:1},8,["loading"])]),default:i(()=>[o(ie,{model:r.value,"label-width":"80px"},{default:i(()=>[o(f,{label:"模板名称",required:""},{default:i(()=>[o(b,{modelValue:r.value.template_name,"onUpdate:modelValue":e[3]||(e[3]=l=>r.value.template_name=l),placeholder:"请输入模板名称"},null,8,["modelValue"])]),_:1}),o(f,{label:"模板描述"},{default:i(()=>[o(b,{modelValue:r.value.description,"onUpdate:modelValue":e[4]||(e[4]=l=>r.value.description=l),type:"textarea",rows:3,placeholder:"请输入模板描述"},null,8,["modelValue"])]),_:1}),o(f,{label:"设为默认"},{default:i(()=>[o(I,{modelValue:r.value.is_default,"onUpdate:modelValue":e[5]||(e[5]=l=>r.value.is_default=l)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(R,{modelValue:$.value,"onUpdate:modelValue":e[8]||(e[8]=l=>$.value=l),title:"模板预览",width:"600px"},{default:i(()=>[a("div",ht,[M.value?(v(),y("div",{key:0,innerHTML:M.value,class:"preview-result"},null,8,xt)):(v(),y("div",gt,"暂无预览内容"))])]),_:1},8,["modelValue"])])}}});const $t=$e(bt,[["__scopeId","data-v-d6a3476f"]]);export{$t as default};
