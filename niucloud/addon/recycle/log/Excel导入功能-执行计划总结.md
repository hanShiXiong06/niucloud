# Excel价格导入功能 - 执行计划总结

## 项目目标
实现Excel价格数据的智能导入，支持每日价格更新和新设备自动入库。

## 核心技术挑战
1. **合并单元格智能处理** - 最复杂的技术点
2. **每日价格更新机制** - 业务核心需求
3. **新设备自动识别入库** - 系统扩展能力
4. **大数据量性能优化** - 系统稳定性

## 开发节点规划（38个节点）

### 🔧 阶段一：基础框架（必须先完成）
**节点 1.1-1.3：建立基础**
- [ ] 1.1 创建5个模型类（品牌、设备、价格、记录、日志）
- [ ] 1.2 建立数据库表结构
- [ ] 1.3 实现日志服务类

**验收重点：** 确保站点隔离、模型关联正确

### 📊 阶段二：Excel解析核心（技术难点）
**节点 2.1-2.4：解决合并单元格问题**
- [ ] 2.1 Excel文件上传和读取
- [ ] 2.2 工作表结构智能分析
- [ ] 2.3 **合并单元格检测算法**（最关键）
- [ ] 2.4 数据行提取算法

**验收重点：** 
```php
// 测试合并单元格处理效果
$mergedData = $parser->detectMergedCells($worksheet, 3, 100);
// 日志必须显示：检测到的合并单元格范围和填充结果
```

### 🔄 阶段三：数据标准化（业务核心）
**节点 3.1-3.3：数据清洗和标准化**
- [ ] 3.1 设备型号识别（品牌识别准确率>95%）
- [ ] 3.2 容量格式标准化（256→256GB, 16+512→16GB+512GB）
- [ ] 3.3 价格数据验证处理

**验收重点：**
```php
// 容量标准化测试
$result = $processor->standardizeCapacity('256');
assert($result === '256GB');
$result = $processor->standardizeCapacity('16+512');
assert($result === '16GB+512GB');
```

### 📱 阶段四：设备管理（新设备处理）
**节点 4.1-4.2：新设备自动入库**
- [ ] 4.1 新设备检测算法
- [ ] 4.2 新设备自动创建入库

**验收重点：** 新设备能自动识别并正确入库，不重复创建

### 💰 阶段五：价格更新（每日更新机制）
**节点 5.1-5.2：每日价格管理**
- [ ] 5.1 **每日价格更新策略**（核心业务）
- [ ] 5.2 价格变更对比算法（预警机制）

**验收重点：**
```php
// 测试每日价格更新
$result = $priceService->updateDailyPrices($deviceId, $newPrices, '2024-01-15', $batch);
// 必须保留历史价格，正确更新当前价格
```

### ⚡ 阶段六：性能优化（系统稳定性）
**节点 6.1-6.2：处理大量数据**
- [ ] 6.1 分批处理机制（每批500条）
- [ ] 6.2 事务处理和回滚

**验收重点：** 10000条数据5分钟内处理完成，内存<512MB

### 🖥️ 阶段七：前端界面（用户体验）
**节点 7.1-7.3：用户界面**
- [ ] 7.1 文件上传组件
- [ ] 7.2 导入进度显示
- [ ] 7.3 结果展示和错误下载

### 🧪 阶段八：测试验证（质量保证）
**节点 8.1-8.3：全面测试**
- [ ] 8.1 单元测试（覆盖率>80%）
- [ ] 8.2 性能测试
- [ ] 8.3 集成测试

## 关键日志调试要求

### 在每个关键节点必须输出的日志：
```php
// 1. Excel解析阶段
$logService->info('工作表分析', [
    'sheet' => $sheetName,
    'title_row' => $titleRow,
    'header_row' => $headerRow,
    'data_rows' => $dataRowCount
]);

// 2. 合并单元格处理
$logService->info('合并单元格处理', [
    'range' => $mergeRange,
    'affected_rows' => $affectedRows,
    'filled_values' => $filledData
]);

// 3. 设备识别
$logService->info('设备识别结果', [
    'original' => $originalData,
    'recognized' => $recognizedData,
    'is_new_device' => $isNew
]);

// 4. 价格更新
$logService->info('价格更新', [
    'device_id' => $deviceId,
    'old_price_json' => '{"高保充新":6800,"充新":6600}',
    'new_price_json' => '{"高保充新":7000,"充新":6900,"靓机":6500}',
    'changes' => $priceChanges
]);

// 5. 批次处理
$logService->info('批次处理状态', [
    'batch' => $batchNo,
    'processed' => $processedCount,
    'success' => $successCount,
    'errors' => $errorCount,
    'memory_usage' => memory_get_usage(true)
]);
```

## 每日价格更新机制详细设计

### 价格更新逻辑：
1. **检查当日是否已有价格记录**
2. **如果有，对比价格变化并更新**
3. **如果没有，创建新的价格记录**
4. **将历史价格标记为非当前价格**
5. **记录价格变更历史**

### 数据库设计重点：
```sql
-- 设备价格表关键字段
`price_date` date NOT NULL,           -- 价格日期
`is_current` tinyint(1) DEFAULT 1,    -- 是否当前价格
`price_data` json NOT NULL,           -- JSON存储多级价格
```

### 价格JSON存储格式：
```json
{
  "高保充新": 7000,
  "充新": 6900,
  "靓机": 6500,
  "小花": 6000,
  "大花": 5500,
  "外爆": 5000,
  "内爆": 4500
}
```

### JSON存储的优势：
- **灵活性**：支持动态价格等级，无需修改表结构
- **扩展性**：新增价格等级只需在JSON中添加键值对
- **查询便利**：MySQL 5.7+支持JSON字段查询和索引
- **存储效率**：相比多字段存储更紧凑

### 新设备处理流程：
1. **解析Excel行数据**
2. **检查设备是否存在**（品牌+型号+网络型号+容量）
3. **如果不存在，自动创建新设备记录**
4. **关联价格数据到设备**

## 验收检查清单

### 核心功能验收：
- [ ] 合并单元格正确解析（测试iPhone 15系列）
- [ ] 容量格式正确标准化（测试256、16+512、1T等）
- [ ] 新设备自动入库（测试新型号）
- [ ] 价格每日更新正常（测试重复导入）
- [ ] 异常数据正确处理（测试错误格式）

### 性能验收：
- [ ] 10000条数据处理时间<5分钟
- [ ] 内存峰值使用<512MB
- [ ] 系统响应正常（不阻塞其他功能）

### 日志验收：
- [ ] 每个处理步骤都有日志记录
- [ ] 错误日志包含完整错误信息
- [ ] 性能日志包含时间和内存使用

### 数据一致性验收：
- [ ] 导入前后数据完整性检查
- [ ] 事务回滚测试
- [ ] 并发导入测试

## 开发优先级建议

### 第一优先级（必须）：
1. **节点 2.3：合并单元格处理** - 技术核心难点
2. **节点 5.1：每日价格更新** - 业务核心需求
3. **节点 4.2：新设备入库** - 系统扩展能力

### 第二优先级（重要）：
1. 数据标准化算法
2. 批量处理性能优化
3. 异常处理和回滚

### 第三优先级（完善）：
1. 前端界面优化
2. 详细测试覆盖
3. 用户体验改进

## 风险预警

### 技术风险：
1. **合并单元格处理复杂性** - 可能需要多轮调试
2. **内存使用控制** - 大文件处理需要优化
3. **数据库性能** - 批量插入需要优化

### 业务风险：
1. **价格变更预警** - 需要设置合理阈值
2. **数据备份** - 重要数据变更前备份
3. **用户培训** - 新功能使用培训

## 成功标准

### 定量指标：
- 合并单元格处理准确率：**100%**
- 设备识别准确率：**>95%**
- 10000条数据处理时间：**<5分钟**
- 内存使用峰值：**<512MB**
- 系统可用性：**>99%**

### 定性指标：
- 每日价格更新流程稳定
- 新设备自动入库正常
- 异常情况恢复机制健全
- 用户操作体验良好

这个分步方案确保了每个节点都足够小，可以独立验收，同时通过详细的日志记录，能够准确追踪每个处理步骤的执行情况。 