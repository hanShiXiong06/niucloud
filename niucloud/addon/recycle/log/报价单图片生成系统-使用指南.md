# æŠ¥ä»·å•å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿ - ä½¿ç”¨æŒ‡å—

## ğŸ“– ç³»ç»Ÿæ¦‚è¿°

æ–°çš„æŠ¥ä»·å•å›¾ç‰‡ç”Ÿæˆç³»ç»Ÿæ”¯æŒä¸‰ç§è½¬æ¢è·¯å¾„ï¼Œè§£å†³äº†ä¹‹å‰ç›´æ¥ç”Ÿæˆå›¾ç‰‡æ•ˆæœä¸ç†æƒ³çš„é—®é¢˜ï¼š

### ğŸ”„ æ”¯æŒçš„è½¬æ¢æ–¹æ³•

1. **JSON â†’ Excel â†’ PDF â†’ PNG** (æ¨è)
   - åˆ©ç”¨ç°æœ‰çš„PhpSpreadsheetç”ŸæˆExcel
   - è½¬æ¢ä¸ºPDFå†è½¬PNGï¼Œä¿è¯è¡¨æ ¼æ ¼å¼å®Œç¾

2. **JSON â†’ HTML â†’ PDF â†’ PNG**
   - ç”Ÿæˆæ ·å¼åŒ–çš„HTMLè¡¨æ ¼
   - è½¬æ¢ä¸ºPDFå†è½¬PNGï¼Œæ”¯æŒå¤æ‚æ ·å¼

3. **ç›´æ¥Imagickç”Ÿæˆ** (å¤‡ç”¨æ–¹æ¡ˆ)
   - æ”¹è¿›ç‰ˆçš„ç›´æ¥ç”Ÿæˆæ–¹å¼
   - å½“å…¶ä»–æ–¹æ³•å¤±è´¥æ—¶çš„å¤‡ç”¨é€‰æ‹©

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸ¨ **å¤šä¸»é¢˜æ”¯æŒ**: é»˜è®¤ã€å•†åŠ¡ã€ç®€çº¦ä¸‰ç§ä¸»é¢˜
- ğŸ“ **è¯¦ç»†æ—¥å¿—**: è®°å½•æ¯æ­¥è½¬æ¢è¿‡ç¨‹å’Œè€—æ—¶
- ğŸ—‚ï¸ **æ–‡ä»¶ç®¡ç†**: è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œæ”¯æŒå†å²è®°å½•
- âš¡ **æ€§èƒ½ä¼˜åŒ–**: æ™ºèƒ½ç¼“å­˜å’Œé”™è¯¯æ¢å¤
- ğŸ¯ **æ•°æ®æºé›†æˆ**: åŸºäºç°æœ‰RecycleExcelServiceæ•°æ®

---

## ğŸš€ APIæ¥å£ä½¿ç”¨

### 1. ç”ŸæˆæŠ¥ä»·å•å›¾ç‰‡

**POST** `/adminapi/recycle/price_image/generate`

```json
{
  "method": "excel_to_png",
  "theme": "business", 
  "filename": "price_list_20241220",
  "brand_id": "158",
  "device_type": "phone",
  "keyword": "iPhone",
  "create_at": "2024-12-20"
}
```

**å“åº”ç¤ºä¾‹:**
```json
{
  "code": 1,
  "message": "æŠ¥ä»·å•å›¾ç‰‡ç”ŸæˆæˆåŠŸ",
  "data": {
    "success": true,
    "data": {
      "image_path": "/upload/price_images/price_list_20241220.png",
      "method": "excel_to_png",
      "theme": "business"
    },
    "convert_log": [
      {
        "step": "å¼€å§‹",
        "message": "æŠ¥ä»·å•å›¾ç‰‡ç”Ÿæˆæµç¨‹å¯åŠ¨",
        "timestamp": "2024-12-20 15:30:45.123456"
      },
      {
        "step": "æ­¥éª¤1.1",
        "message": "JSONæ•°æ®ç”Ÿæˆå®Œæˆ",
        "timestamp": "2024-12-20 15:30:45.234567",
        "data": {"count": 150}
      }
    ],
    "duration_ms": 1234.56
  }
}
```

### 2. è·å–è½¬æ¢æ–¹æ³•åˆ—è¡¨

**GET** `/adminapi/recycle/price_image/methods`

```json
{
  "code": 1,
  "data": [
    {
      "key": "excel_to_png",
      "name": "Excelè½¬PNG",
      "description": "JSON â†’ Excel â†’ PDF â†’ PNG å¤šæ­¥è½¬æ¢",
      "recommended": true
    },
    {
      "key": "html_to_png",
      "name": "HTMLè½¬PNG", 
      "description": "JSON â†’ HTML â†’ PDF â†’ PNG å¤šæ­¥è½¬æ¢",
      "recommended": false
    },
    {
      "key": "direct_imagick",
      "name": "ç›´æ¥ç”Ÿæˆ",
      "description": "ä½¿ç”¨Imagickç›´æ¥ç”Ÿæˆå›¾ç‰‡",
      "recommended": false
    }
  ]
}
```

### 3. è·å–ä¸»é¢˜åˆ—è¡¨

**GET** `/adminapi/recycle/price_image/themes`

```json
{
  "code": 1,
  "data": [
    {
      "key": "default",
      "name": "é»˜è®¤ä¸»é¢˜",
      "description": "ç®€æ´çš„ç°è‰²ä¸»é¢˜",
      "color": "#e7e6e6"
    },
    {
      "key": "business",
      "name": "å•†åŠ¡ä¸»é¢˜", 
      "description": "ä¸“ä¸šçš„è“è‰²å•†åŠ¡ä¸»é¢˜",
      "color": "#4472C4"
    },
    {
      "key": "minimal",
      "name": "ç®€çº¦ä¸»é¢˜",
      "description": "æç®€çš„ç°è‰²ä¸»é¢˜", 
      "color": "#f2f2f2"
    }
  ]
}
```

### 4. é¢„è§ˆæŠ¥ä»·å•

**POST** `/adminapi/recycle/price_image/preview`

```json
{
  "theme": "business",
  "brand_id": "158"
}
```

**å“åº”:**
```json
{
  "code": 1,
  "data": {
    "html_content": "<!DOCTYPE html>...",
    "data_count": 150,
    "theme": "business"
  }
}
```

### 5. ä¸‹è½½å›¾ç‰‡

**GET** `/adminapi/recycle/price_image/download?filename=price_list_20241220.png`

ç›´æ¥è¿”å›æ–‡ä»¶ä¸‹è½½ã€‚

### 6. è·å–å†å²è®°å½•

**GET** `/adminapi/recycle/price_image/history?page=1&limit=20`

```json
{
  "code": 1,
  "data": {
    "list": [
      {
        "filename": "price_list_20241220.png",
        "size": 245760,
        "format_size": "240.00 KB",
        "create_time": 1703080800,
        "format_time": "2024-12-20 15:30:45",
        "download_url": "/addon/recycle/price_image/download?filename=price_list_20241220.png"
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 20
  }
}
```

### 7. åˆ é™¤å›¾ç‰‡

**DELETE** `/adminapi/recycle/price_image/delete?filename=price_list_20241220.png`

### 8. æ‰¹é‡åˆ é™¤

**POST** `/adminapi/recycle/price_image/batch_delete`

```json
{
  "filenames": ["file1.png", "file2.png"]
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. åŸºç¡€æµ‹è¯•

```bash
# æµ‹è¯•è·å–è½¬æ¢æ–¹æ³•
curl -X GET "http://your-domain/adminapi/recycle/price_image/methods" \
  -H "token: your-admin-token"

# æµ‹è¯•è·å–ä¸»é¢˜åˆ—è¡¨  
curl -X GET "http://your-domain/adminapi/recycle/price_image/themes" \
  -H "token: your-admin-token"
```

### 2. é¢„è§ˆæµ‹è¯•

```bash
# æµ‹è¯•é¢„è§ˆåŠŸèƒ½
curl -X POST "http://your-domain/adminapi/recycle/price_image/preview" \
  -H "Content-Type: application/json" \
  -H "token: your-admin-token" \
  -d '{
    "theme": "business",
    "brand_id": "158"
  }'
```

### 3. ç”Ÿæˆæµ‹è¯•

```bash
# æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ - Excelè½¬æ¢æ–¹æ³•
curl -X POST "http://your-domain/adminapi/recycle/price_image/generate" \
  -H "Content-Type: application/json" \
  -H "token: your-admin-token" \
  -d '{
    "method": "excel_to_png",
    "theme": "business",
    "brand_id": "158",
    "filename": "test_excel_method"
  }'

# æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ - HTMLè½¬æ¢æ–¹æ³•
curl -X POST "http://your-domain/adminapi/recycle/price_image/generate" \
  -H "Content-Type: application/json" \
  -H "token: your-admin-token" \
  -d '{
    "method": "html_to_png", 
    "theme": "minimal",
    "device_type": "phone",
    "filename": "test_html_method"
  }'

# æµ‹è¯•å›¾ç‰‡ç”Ÿæˆ - ç›´æ¥Imagickæ–¹æ³•
curl -X POST "http://your-domain/adminapi/recycle/price_image/generate" \
  -H "Content-Type: application/json" \
  -H "token: your-admin-token" \
  -d '{
    "method": "direct_imagick",
    "theme": "default", 
    "keyword": "iPhone",
    "filename": "test_imagick_method"
  }'
```

### 4. ç®¡ç†æµ‹è¯•

```bash
# è·å–å†å²è®°å½•
curl -X GET "http://your-domain/adminapi/recycle/price_image/history" \
  -H "token: your-admin-token"

# ä¸‹è½½æ–‡ä»¶
curl -X GET "http://your-domain/adminapi/recycle/price_image/download?filename=test_excel_method.png" \
  -H "token: your-admin-token" \
  -o "downloaded_image.png"
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
niucloud/addon/recycle/app/service/admin/price_image/
â”œâ”€â”€ PriceImageService.php           # ä¸»æœåŠ¡ç±»
â””â”€â”€ (æœªæ¥æ‰©å±•)
    â”œâ”€â”€ PriceThemeManager.php      # ä¸»é¢˜ç®¡ç†å™¨  
    â”œâ”€â”€ WatermarkProcessor.php     # æ°´å°å¤„ç†å™¨
    â””â”€â”€ ImageMerger.php            # å›¾ç‰‡åˆå¹¶å™¨

niucloud/addon/recycle/app/adminapi/controller/price_image/
â””â”€â”€ PriceImageController.php       # APIæ§åˆ¶å™¨

public/upload/
â”œâ”€â”€ price_images/                  # ç”Ÿæˆçš„å›¾ç‰‡æ–‡ä»¶
â”œâ”€â”€ temp/                         # ä¸´æ—¶æ–‡ä»¶ç›®å½•
â””â”€â”€ excel/export/                 # Excelå¯¼å‡ºç›®å½•
```

---

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Imagickæ‰©å±•æœªå®‰è£…**
   - ç¡®ä¿PHPå·²å®‰è£…Imagickæ‰©å±•
   - æ£€æŸ¥`php -m | grep imagick`

2. **ä¸­æ–‡å­—ä½“é—®é¢˜**
   - ç¡®ä¿`resource/fonts/simhei.ttf`å­˜åœ¨
   - æˆ–ä¿®æ”¹å­—ä½“è·¯å¾„é…ç½®

3. **æƒé™é—®é¢˜** 
   - ç¡®ä¿`public/upload/`ç›®å½•å¯å†™
   - æ£€æŸ¥ç›®å½•æƒé™755

4. **å†…å­˜ä¸è¶³**
   - å¢åŠ PHPå†…å­˜é™åˆ¶
   - å¤„ç†å¤§æ•°æ®é‡æ—¶åˆ†æ‰¹å¤„ç†

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹è½¬æ¢æ—¥å¿—**
   - ç”Ÿæˆæ¥å£è¿”å›è¯¦ç»†çš„convert_log
   - è®°å½•æ¯æ­¥éª¤çš„è€—æ—¶å’ŒçŠ¶æ€

2. **æ£€æŸ¥ä¸´æ—¶æ–‡ä»¶**
   - ä¸´æ—¶æ–‡ä»¶åœ¨`public/upload/temp/`
   - è½¬æ¢å¤±è´¥æ—¶ä¿ç•™ç”¨äºè°ƒè¯•

3. **é€æ­¥æµ‹è¯•**
   - å…ˆæµ‹è¯•é¢„è§ˆåŠŸèƒ½
   - å†æµ‹è¯•ä¸åŒè½¬æ¢æ–¹æ³•
   - æœ€åæµ‹è¯•å¤æ‚æŸ¥è¯¢æ¡ä»¶

---

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### 1. æ—¥å¸¸æŠ¥ä»·å•ç”Ÿæˆ
```json
{
  "method": "excel_to_png",
  "theme": "business",
  "create_at": "2024-12-20",
  "filename": "daily_price_20241220"
}
```

### 2. å“ç‰Œä¸“å±æŠ¥ä»·å•
```json
{
  "method": "excel_to_png", 
  "theme": "business",
  "brand_id": "158",
  "filename": "apple_price_list"
}
```

### 3. è®¾å¤‡ç±»å‹æŠ¥ä»·å•
```json
{
  "method": "html_to_png",
  "theme": "minimal",
  "device_type": "phone", 
  "filename": "phone_price_list"
}
```

### 4. æœç´¢ç»“æœæŠ¥ä»·å•
```json
{
  "method": "direct_imagick",
  "theme": "default",
  "keyword": "iPhone 15",
  "filename": "iphone15_search_result"
}
```

---

## ğŸ“ å¼€å‘å¤‡æ³¨

- âœ… åŸºç¡€å¤šè½¬æ¢è·¯å¾„å·²å®ç°
- âœ… è¯¦ç»†è½¬æ¢æ—¥å¿—å·²å®ç°  
- âœ… æ–‡ä»¶ç®¡ç†åŠŸèƒ½å·²å®ç°
- ğŸ”„ PDFè½¬æ¢éƒ¨åˆ†éœ€è¦è¿›ä¸€æ­¥å®Œå–„
- ğŸ”„ æ°´å°åŠŸèƒ½å¯ä»¥åç»­æ‰©å±•
- ğŸ”„ æ‰¹é‡ç”ŸæˆåŠŸèƒ½å¯ä»¥åç»­æ·»åŠ 

å½“å‰ç‰ˆæœ¬ä¸“æ³¨äºè§£å†³åŸæœ‰æ–¹æ¡ˆçš„é—®é¢˜ï¼Œæä¾›æ›´å¯é çš„å¤šæ­¥è½¬æ¢è·¯å¾„ã€‚ 