# æ¥å£æ•°æ®ç»“æ„ä¿®å¤è¯´æ˜

## ğŸ¯ ä¿®å¤ç›®æ ‡

ç¡®ä¿æ‰€æœ‰ç»Ÿè®¡æ¥å£**å³ä½¿æ•°æ®ä¸º0ï¼Œä¹Ÿè¿”å›å®Œæ•´çš„æ•°æ®ç»“æ„**ï¼Œè€Œä¸æ˜¯ç©ºæ•°ç»„ `[]`ã€‚

## ğŸ› é—®é¢˜æè¿°

### ä¿®å¤å‰

å½“æ•°æ®åº“ä¸­æ²¡æœ‰ä»»ä½•æ“ä½œè®°å½•æ—¶ï¼š

```json
// getUserList æ¥å£
[]

// getUserDetailStats æ¥å£  
[]

// å‰ç«¯å›¾è¡¨
æ˜¾ç¤ºï¼š"æš‚æ— æ•°æ®"
é—®é¢˜ï¼šæ— æ³•æ¸²æŸ“å›¾è¡¨ç»“æ„
```

### ä¿®å¤å

å³ä½¿æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿè¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„å®Œæ•´ç»“æ„ï¼š

```json
// getUserList æ¥å£
[
  {
    "uid": 1,
    "username": "admin",
    "real_name": "ç®¡ç†å‘˜"
  }
]

// getUserDetailStats æ¥å£
[
  {
    "user_id": 1,
    "user_name": "ç®¡ç†å‘˜",
    "user_type_name": "è¶…çº§ç®¡ç†å‘˜",
    "period_text": "2024-01-01 è‡³ 2024-12-31",
    "signed_order_count": 0,     // â† å³ä½¿ä¸º0ä¹Ÿè¿”å›
    "signed_device_count": 0,
    "category_breakdown_text": "",
    "check_count": 0,
    "check_category_text": "",
    "price_count": 0,
    "payment_count": 0
  }
]

// å‰ç«¯å›¾è¡¨
æ˜¾ç¤ºï¼šå®Œæ•´çš„å›¾è¡¨ç»“æ„ + ç°è‰²æ˜¾ç¤º + "æš‚æ— æ•°æ®"æç¤º
æ•ˆæœï¼šâœ… ç”¨æˆ·èƒ½çœ‹åˆ°å›¾è¡¨æ¡†æ¶ï¼Œä½“éªŒæ›´å¥½
```

## ğŸ”§ ä¿®å¤å†…å®¹

### 1. getUserList() æ–¹æ³•ä¿®å¤

**ä½ç½®**ï¼š`RecycleStatsService.php` ç¬¬489-511è¡Œ

**ä¿®æ”¹å‰ï¼š**
```php
if (empty($allUserIds)) {
    return [];  // â† ç›´æ¥è¿”å›ç©ºæ•°ç»„
}
```

**ä¿®æ”¹åï¼š**
```php
// å¦‚æœæ²¡æœ‰ä»»ä½•ç”¨æˆ·æœ‰æ“ä½œè®°å½•ï¼Œè‡³å°‘è¿”å›å½“å‰ç™»å½•ç”¨æˆ·
if (empty($allUserIds)) {
    Log::info('æ²¡æœ‰ç”¨æˆ·æ“ä½œè®°å½•ï¼Œè¿”å›å½“å‰ç™»å½•ç”¨æˆ·', ['uid' => $this->uid]);
    $allUserIds = [$this->uid];  // â† ä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·
}

// è·å–ç”¨æˆ·ä¿¡æ¯
$users = SysUser::where('uid', 'in', $allUserIds)
    ->field('uid, username, real_name')
    ->select()
    ->toArray();

Log::info('getUserListè¿”å›ç”¨æˆ·æ•°é‡:', ['count' => count($users), 'users' => $users]);

return $users;
```

### 2. getUserDetailStats() æ–¹æ³•ä¿®å¤

**ä½ç½®**ï¼š`RecycleStatsService.php` ç¬¬536-560è¡Œ

**ä¿®æ”¹å†…å®¹ï¼š**æ·»åŠ äº†åŒé‡ä¿éšœ

#### ä¿éšœ1ï¼šgetUserList è¿”å›ç©ºæ—¶

```php
// è·å–ç”¨æˆ·åˆ—è¡¨
$users = $this->getUserList();

// å¦‚æœæ²¡æœ‰ç”¨æˆ·åˆ—è¡¨ï¼Œè‡³å°‘è¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„æ•°æ®ï¼ˆå…¨ä¸º0ï¼‰
if (empty($users)) {
    Log::info('getUserListè¿”å›ç©ºï¼Œä½¿ç”¨å½“å‰ç™»å½•ç”¨æˆ·');
    $currentUser = SysUser::where('uid', $this->uid)->field('uid, username, real_name')->find();
    if ($currentUser) {
        $users = [$currentUser->toArray()];
    }
}
```

#### ä¿éšœ2ï¼šç­›é€‰ç‰¹å®šç”¨æˆ·åä¸ºç©º

```php
if ($specificUserId) {
    $users = array_filter($users, function($user) use ($specificUserId) {
        return $user['uid'] == $specificUserId;
    });
    
    // å¦‚æœç­›é€‰åä¸ºç©ºï¼Œä½†æŒ‡å®šäº†ç”¨æˆ·IDï¼Œå°è¯•è·å–è¯¥ç”¨æˆ·ä¿¡æ¯
    if (empty($users)) {
        $specificUser = SysUser::where('uid', $specificUserId)->field('uid, username, real_name')->find();
        if ($specificUser) {
            $users = [$specificUser->toArray()];
        }
    }
}
```

### 3. getOverviewStats() æ–¹æ³•

**çŠ¶æ€**ï¼šâœ… æ— éœ€ä¿®æ”¹

è¯¥æ–¹æ³•å·²ç»æ­£ç¡®è¿”å›å®Œæ•´çš„æ•°æ®ç»“æ„ï¼š

```php
return [
    'today_order_count' => $todayOrderCount,        // å³ä½¿ä¸º0ä¹Ÿè¿”å›
    'yesterday_order_count' => $yesterdayOrderCount,
    'today_check_count' => $todayCheckCount,
    'today_check_breakdown' => $checkBreakdown,      // ç©ºæ•°ç»„è€Œénull
    'today_price_count' => $todayPriceCount,
    'today_payment_amount' => $todayPaymentAmount,
    'today_payment_count' => $todayPaymentCount,
    'today_return_count' => $todayReturnCount
];
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è¯·æ±‚ getUserDetailStats                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getUserList() è·å–ç”¨æˆ·åˆ—è¡¨                       â”‚
â”‚                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æŸ¥è¯¢æ•°æ®åº“ï¼šæœ‰æ“ä½œè®°å½•çš„ç”¨æˆ·             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â”‚                             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚         â”‚                   â”‚                   â”‚
â”‚   æœ‰ç”¨æˆ·è®°å½•ï¼Ÿ          æ²¡æœ‰è®°å½•               â”‚
â”‚         â”‚                   â”‚                   â”‚
â”‚   è¿”å›ç”¨æˆ·åˆ—è¡¨        è¿”å›å½“å‰ç™»å½•ç”¨æˆ· â† ä¿®å¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getUserDetailStats() è®¡ç®—ç»Ÿè®¡æ•°æ®                â”‚
â”‚                                                 â”‚
â”‚ å¯¹æ¯ä¸ªç”¨æˆ·ï¼š                                     â”‚
â”‚   - signed_order_count: 0                      â”‚
â”‚   - check_count: 0                             â”‚
â”‚   - price_count: 0                             â”‚
â”‚   - payment_count: 0                           â”‚
â”‚                                                 â”‚
â”‚ âœ… è¿”å›å®Œæ•´æ•°æ®ç»“æ„ï¼ˆå³ä½¿å…¨ä¸º0ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯æ¥æ”¶æ•°æ®                                     â”‚
â”‚                                                 â”‚
â”‚ [{                                              â”‚
â”‚   "user_id": 1,                                 â”‚
â”‚   "user_name": "ç®¡ç†å‘˜",                        â”‚
â”‚   "signed_order_count": 0,                     â”‚
â”‚   "check_count": 0,                            â”‚
â”‚   ...                                          â”‚
â”‚ }]                                              â”‚
â”‚                                                 â”‚
â”‚ âœ… å›¾è¡¨èƒ½æ­£å¸¸æ¸²æŸ“ï¼ˆæ˜¾ç¤ºç©ºçŠ¶æ€ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¨ å‰ç«¯æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘˜å·¥å·¥ä½œç»Ÿè®¡                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚
â”‚   æ¥å£è¿”å› []               â”‚
â”‚                             â”‚
â”‚   ä»€ä¹ˆéƒ½ä¸æ˜¾ç¤º               â”‚
â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤å

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘˜å·¥å·¥ä½œç»Ÿè®¡                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘˜å·¥      è§’è‰²      ç­¾æ”¶å•  è´¨æ£€  å®šä»·  æ‰“æ¬¾ â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ç®¡ç†å‘˜  è¶…çº§ç®¡ç†å‘˜    0      0     0     0  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œé‡å¯¹æ¯”                   â”‚
â”‚                             â”‚
â”‚    â•­â”€â”€â”€â”€â”€â”€â”€â”€â•®               â”‚
â”‚    â”‚æš‚æ— æ•°æ®â”‚               â”‚
â”‚    â•°â”€â”€â”€â”€â”€â”€â”€â”€â•¯               â”‚
â”‚                             â”‚
â”‚ â– ç­¾æ”¶ â– è´¨æ£€ â– å®šä»· â– æ‰“æ¬¾     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•ç©ºæ•°æ®æƒ…å†µ

```bash
# æ¸…ç©ºæµ‹è¯•æ•°æ®
mysql> DELETE FROM recycle_device WHERE site_id = 0;
mysql> DELETE FROM recycle_order WHERE site_id = 0;

# æ¸…é™¤ç¼“å­˜
php think clear

# è®¿é—®æ¥å£
curl http://your-domain/addon/recycle/stats/getUserDetailStats
```

**é¢„æœŸè¿”å›ï¼š**
```json
{
  "code": 0,
  "data": [
    {
      "user_id": 1,
      "user_name": "ç®¡ç†å‘˜",
      "user_type_name": "è¶…çº§ç®¡ç†å‘˜",
      "period_text": "å…¨éƒ¨æ—¶é—´",
      "signed_order_count": 0,
      "signed_device_count": 0,
      "category_breakdown_text": "",
      "check_count": 0,
      "check_category_text": "",
      "price_count": 0,
      "payment_count": 0
    }
  ]
}
```

### 2. æµ‹è¯•æœ‰æ•°æ®æƒ…å†µ

æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®åï¼Œæ¥å£åº”è¯¥è¿”å›å®é™…çš„ç»Ÿè®¡å€¼ã€‚

### 3. æµ‹è¯•å‰ç«¯å›¾è¡¨

- **è¡¨æ ¼**ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€æœ‰æ•°å€¼ä¸º0
- **å›¾è¡¨**ï¼šæ˜¾ç¤ºç°è‰²çš„å›¾è¡¨ç»“æ„ + "æš‚æ— æ•°æ®"æç¤º
- **ç¯å½¢å›¾**ï¼šæ˜¾ç¤ºç°è‰²çš„ç¯å½¢ + "æš‚æ— æ•°æ®"æç¤º

## ğŸ“ æ—¥å¿—ç›‘æ§

ä¿®æ”¹åæ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼š

```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f runtime/log/$(date +%Y%m%d).log | grep -E "getUserList|getUserDetailStats"
```

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
[2024-XX-XX 10:00:00] getUserListæƒé™æ£€æŸ¥: {"uid":1,"role":"admin","site_id":0}
[2024-XX-XX 10:00:00] æ²¡æœ‰ç”¨æˆ·æ“ä½œè®°å½•ï¼Œè¿”å›å½“å‰ç™»å½•ç”¨æˆ·: {"uid":1}
[2024-XX-XX 10:00:00] getUserListè¿”å›ç”¨æˆ·æ•°é‡: {"count":1,"users":[{"uid":1,"username":"admin","real_name":"ç®¡ç†å‘˜"}]}
[2024-XX-XX 10:00:00] getUserDetailStatsæƒé™æ£€æŸ¥: {"uid":1,"role":"admin","site_id":0,"params":[]}
```

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. ç”¨æˆ·ä½“éªŒæå‡

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æ— æ•°æ®æ—¶ | ç©ºç™½é¡µé¢ï¼Œç”¨æˆ·å›°æƒ‘ | æ˜¾ç¤ºå›¾è¡¨æ¡†æ¶ï¼Œæç¤º"æš‚æ— æ•°æ®" |
| ç­›é€‰å‘˜å·¥æ—¶ | æŸäº›å‘˜å·¥æ˜¾ç¤ºç©ºç™½ | æ‰€æœ‰å‘˜å·¥éƒ½æœ‰å®Œæ•´ç»“æ„ |
| å›¾è¡¨æ¸²æŸ“ | æ— æ³•æ¸²æŸ“ | æ­£å¸¸æ¸²æŸ“ç©ºçŠ¶æ€ |

### 2. æ•°æ®ä¸€è‡´æ€§

- âœ… æ‰€æœ‰æ¥å£éƒ½è¿”å›ç»Ÿä¸€çš„æ•°æ®ç»“æ„
- âœ… å­—æ®µåç§°ä¿æŒä¸€è‡´
- âœ… æ•°æ®ç±»å‹ä¿æŒä¸€è‡´ï¼ˆæ•°å­—ä¸º0ï¼Œå­—ç¬¦ä¸²ä¸ºç©ºï¼‰

### 3. å‰ç«¯å®¹é”™æ€§

å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹ï¼Œå› ä¸ºï¼š
- ä¹‹å‰æœŸæœ›æ•°ç»„ï¼Œç°åœ¨è¿”å›æ•°ç»„
- ä¹‹å‰æœŸæœ›å¯¹è±¡å­—æ®µï¼Œç°åœ¨å­—æ®µéƒ½å­˜åœ¨ï¼ˆå€¼ä¸º0ï¼‰
- å›¾è¡¨ç»„ä»¶å·²ç»å¤„ç†äº†æ•°æ®ä¸º0çš„æƒ…å†µ

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**ï¼š
   - æœ€å¤šå¢åŠ 1-2æ¬¡æ•°æ®åº“æŸ¥è¯¢
   - æŸ¥è¯¢æ¡ä»¶ç®€å•ï¼Œæ€§èƒ½å½±å“å¯å¿½ç•¥

2. **å®‰å…¨æ€§**ï¼š
   - ä»…è¿”å›å½“å‰ç™»å½•ç”¨æˆ·çš„æ•°æ®
   - ä¸ä¼šæ³„éœ²å…¶ä»–ç”¨æˆ·ä¿¡æ¯

3. **å…¼å®¹æ€§**ï¼š
   - å‘ä¸‹å…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
   - å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šï¼Œæ¢å¤ä»¥ä¸‹ä»£ç ï¼š

```php
// getUserList æ–¹æ³•
if (empty($allUserIds)) {
    return [];
}

// getUserDetailStats æ–¹æ³•
$users = $this->getUserList();
// åˆ é™¤æ·»åŠ çš„ä¿éšœä»£ç 
```

## ğŸ“… ä¿®æ”¹è®°å½•

- **ä¿®æ”¹æ—¥æœŸ**ï¼š2024-XX-XX
- **æ–‡ä»¶**ï¼š`addon/recycle/app/service/admin/stats/RecycleStatsService.php`
- **ä¿®æ”¹æ–¹æ³•**ï¼š
  - `getUserList()` - ç¬¬489-511è¡Œ
  - `getUserDetailStats()` - ç¬¬536-560è¡Œ

---

**ä¿®å¤å®Œæˆï¼ç°åœ¨æ‰€æœ‰æ¥å£éƒ½ä¼šè¿”å›å®Œæ•´çš„æ•°æ®ç»“æ„ï¼Œå³ä½¿å€¼ä¸º0ã€‚** ğŸ‰

