<template>
  <div class="recycle-order-list h-full">
    <el-card class="box-card !border-none h-full relative" shadow="never">
      <div class="flex justify-between items-center mb-4">
        <span class="text-xl font-semibold text-gray-800">üì± ÂõûÊî∂ËÆ¢ÂçïÁÆ°ÁêÜ</span>
        <div class="btn-wrap">
          <el-button type="primary" :icon="Plus" @click="showAddOrderDialog"
            >‰ª£‰∏ãÂçï</el-button
          >
        </div>
      </div>

      <!-- üîç Êô∫ËÉΩÊêúÁ¥¢Á≥ªÁªü - Âê∏È°∂Âõ∫ÂÆöÊòæÁ§∫ -->
      <div class="mb-3 sticky top-30 z-50 bg-white/95 backdrop-blur-sm shadow-lg rounded-lg p-2 -mx-2">
     


              <!-- ÊêúÁ¥¢Ë°®Âçï -->
              <div class="p-2">
                <el-form :inline="true" :model="advancedSearchForm">
                  <!-- Á¨¨‰∏ÄË°åÔºöËÆ¢Âçï‰ø°ÊÅØ -->
                  <el-form-item label="ËÆ¢ÂçïÁºñÂè∑">
                    <el-input
                        v-model="advancedSearchForm.order_id"
                        placeholder="ËæìÂÖ•Á≤æÁ°ÆËÆ¢ÂçïÂè∑"
                        clearable
                        class="w-full"
                      />
                  </el-form-item>

                  <el-form-item label="Âø´ÈÄíÂçïÂè∑">
                    <el-input
                        v-model="advancedSearchForm.express_no"
                        placeholder="ËæìÂÖ•Âø´ÈÄíÂçïÂè∑"
                        clearable
                        class="w-full"
                      />
                  </el-form-item>
                  
                  <el-form-item label="ËÆ¢ÂçïÁä∂ÊÄÅ">
                    <el-select
                        v-model="advancedSearchForm.status"
                        placeholder="ÈÄâÊã©Áä∂ÊÄÅ"
                        clearable
                        multiple
                        collapse-tags
                        class="w-full"
                      >
                        <el-option
                          v-for="(status, key) in orderStatusMap"
                          :key="key"
                          :label="status.name"
                          :value="status.status"
                        >
                        </el-option>  
                      </el-select>
                  </el-form-item>
                  <el-form-item label="Áî®Êà∑ÊêúÁ¥¢">
                    <member-select
                      v-model="advancedSearchForm.member_id"
                      placeholder="üîç ËæìÂÖ•Áî®Êà∑ÊòµÁß∞„ÄÅÊâãÊú∫Âè∑ÊàñÁî®Êà∑ÁºñÂè∑"
                      @change="handleMemberChange"
                      class="w-full"
                    />
                  </el-form-item> 
                  <el-form-item label="Áî®Êà∑ÊâãÊú∫Âè∑">
                    <el-input
                      v-model="advancedSearchForm.user_mobile"
                      placeholder="ËæìÂÖ•Áî®Êà∑ÊâãÊú∫Âè∑"
                      clearable
                      class="w-full"
                    />
                  </el-form-item>

                  <el-form-item label="ÈÖçÈÄÅÊñπÂºè">
                    <el-select
                      v-model="advancedSearchForm.delivery_type"
                      placeholder="ÈÄâÊã©ÈÖçÈÄÅÊñπÂºè"
                      clearable
                      multiple
                      class="w-full"
                    >
                      <el-option label="üì¶ Âø´ÈÄíÈÖçÈÄÅ" value="1" />
                      <el-option label="üöó Ëá™ÈÄÅÂà∞Â∫ó" value="2" />
                    </el-select>
                  </el-form-item>
                  <el-form-item label="ËÆæÂ§áIMEI">
                    <el-input
                      v-model="advancedSearchForm.device_imei"
                      placeholder="ËæìÂÖ•ËÆæÂ§áIMEIÂè∑"
                      clearable
                      class="w-full"
                    />
                  </el-form-item>
                  <el-form-item label="ËÆæÂ§áÂûãÂè∑">
                    <el-input
                      v-model="advancedSearchForm.device_model"
                      placeholder="ËæìÂÖ•ËÆæÂ§áÂûãÂè∑"
                      clearable
                      class="w-full"
                    />
                  </el-form-item>
                  <el-form-item label="ÂàõÂª∫Êó∂Èó¥">
                    <el-date-picker
                      v-model="advancedSearchForm.create_time_range"
                      type="daterange"
                      range-separator="Ëá≥"
                      start-placeholder="ÂºÄÂßãÊó•Êúü"
                      end-placeholder="ÁªìÊùüÊó•Êúü"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      class="w-full"
                    />
                  </el-form-item>
                  <!-- Á≠æÊî∂Êó∂Èó¥ -->
                  <el-form-item label="Á≠æÊî∂Êó∂Èó¥">
                    <el-date-picker
                      v-model="advancedSearchForm.sign_at"
                      type="daterange"
                      range-separator="Ëá≥"
                      start-placeholder="ÂºÄÂßãÊó•Êúü"
                      end-placeholder="ÁªìÊùüÊó•Êúü"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      class="w-full"
                    />
                  </el-form-item>
                  <!-- ÂÆåÊàêÊó∂Èó¥ -->
                  <el-form-item label="Ë¥®Ê£ÄÊó∂Èó¥">
                    <el-date-picker
                      v-model="advancedSearchForm.complete_at"
                      type="daterange"
                      range-separator="Ëá≥"
                      start-placeholder="ÂºÄÂßãÊó•Êúü"
                      end-placeholder="ÁªìÊùüÊó•Êúü"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      class="w-full"
                    />
                  </el-form-item>
                  <!-- ÊâìÊ¨æÊó∂Èó¥ -->
                  <el-form-item label="ÊâìÊ¨æÊó∂Èó¥">
                    <el-date-picker
                      v-model="advancedSearchForm.pay_time"
                      type="daterange"
                      range-separator="Ëá≥"
                      start-placeholder="ÂºÄÂßãÊó•Êúü"
                      end-placeholder="ÁªìÊùüÊó•Êúü"
                      format="YYYY-MM-DD"
                      value-format="YYYY-MM-DD"
                      class="w-full"
                    />
                  </el-form-item>

                  <!-- Êìç‰ΩúÊåâÈíÆ -->
                  <div class="flex justify-center pt-4 border-t border-orange-200">
                    <div class="flex gap-3">
                      <el-button
                        type="primary"
                        :icon="Search"
                        @click="advancedSearch"
                        class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 border-0 shadow-sm px-6"
                      >
                        ÊâßË°åÈ´òÁ∫ßÊêúÁ¥¢
                      </el-button>
                      <el-button 
                        :icon="Refresh" 
                        @click="resetAdvancedSearch"
                        class="border-gray-300 text-gray-600 hover:border-gray-400 px-6"
                      >
                        ÈáçÁΩÆÊâÄÊúâÊù°‰ª∂
                      </el-button>
                    </div>
                  </div>
                </el-form>
              </div>

      </div>

      <!-- Áä∂ÊÄÅÊ†áÁ≠æÈ°µ -->
      <el-tabs
        v-model="activeTab"
        @tab-click="handleTabClick"
        class="order-tabs"
      >
        <el-tab-pane name="">
          <template #label>
            <div class="flex items-center">
              <el-icon class="mr-1"><Document /></el-icon>
              <span>ÂÖ®ÈÉ®</span>
             
            </div>
          </template>
        </el-tab-pane>
        <el-tab-pane
          v-for="(item, key) in orderStatusMap"
          :key="key"
          :name="item.status"
        >
          <template #label>
            <div class="flex items-center">
              <el-icon class="mr-1">
                <component :is="getStatusIcon(item.status)" />
              </el-icon>
              <span>{{ item.name }}</span>
              <el-badge
              v-if="item.status<7"
                :value="getStatusCount(item.status)"
                class="ml-1"
                :type="getStatusBadgeType(item.status)"
              />
            </div>
          </template>
        </el-tab-pane>
      </el-tabs>

   
      <!-- ÂàóË°® -->
      <el-table
        ref="orderTable"
        v-loading="loading"
        :data="list"
        :expand-row-keys="expandRowKeys"
        row-key="id"
        style="width: 100%"
        @expand-change="handleExpandChange"
        class="order-table"
      >
        <el-table-column type="expand">
          <template #default="{ row }">
            <div class="device-expansion-panel">
              <div class="panel-header mb-3">
                <h4 class="text-lg font-medium text-gray-800">üì± ËÆæÂ§áÂàóË°®</h4>
                <span class="text-sm text-gray-500"
                  >ÂÖ± {{ row.devices?.length || 0 }} Âè∞ËÆæÂ§á</span
                >
              </div>
              <el-table
                :data="row.devices"
                border
                size="small"
                @selection-change="
                  (val) => handleDeviceSelectionChange(val, row.id)
                "
                class="device-table"
              >
             
                <el-table-column type="selection" width="55" />

                <el-table-column prop="imei" label="IMEI" min-width="150" />
                <el-table-column
                  prop="model"
                  label="ËÆæÂ§áÂûãÂè∑"
                  min-width="120"
                />
                <el-table-column
                  prop="final_price"
                  label="ÊúÄÁªà‰ª∑Ê†º"
                  width="100"
                >
                  <template #default="{ row }">
                    <span class="price-text">{{
                      formatPrice(row.final_price)
                    }}</span>
                  </template>
                </el-table-column>
                <el-table-column prop="status_name" label="Áä∂ÊÄÅ" width="100">
                  <template #default="{ row }">
                    <el-tag
                      :type="getDeviceStatusType(row.status)"
                      size="small"
                    >
                      {{ row.status_name }}
                    </el-tag>
                  </template>
                </el-table-column>
                <el-table-column label="Êìç‰Ωú" min-width="280">
                  <template #default="{ row }">
                    <el-button-group>
                      <el-button
                        v-if="
                          row.status === 1 && findOrderStatus(row.order_id) > 1
                        "
                        type="primary"
                        size="small"
                        :icon="DocumentChecked"
                        @click="checkDevice(row)"
                      >
                        ÂºÄÂßãË¥®Ê£Ä
                      </el-button>

                      <el-button
                        v-if="row.status == 2 || row.status == 3"
                        type="success"
                        size="small"
                        :icon="PriceTag"
                        @click="priceDevice(row)"
                      >
                        ÂÆö‰ª∑
                      </el-button>

                      <el-button
                        v-if="row.status == 4"
                        type="primary"
                        size="small"
                        :icon="Check"
                        @click="batchRecycleDevice(row.id)"
                      >
                        Á°ÆËÆ§
                      </el-button>
                      <el-button
                        v-if="row.status == 4"
                        type="warning"
                        size="small"
                        :icon="Edit"
                        @click="priceDevice(row)"
                      >
                        ÈáçÊñ∞ÂÆö‰ª∑
                      </el-button>
                      <el-button
                        v-if="row.status == 4"
                        type="danger"
                        size="small"
                        :icon="Close"
                        @click="batchReturnDevice(row.id)"
                      >
                        ÊãíÁªù
                      </el-button>

                      <el-button
                        v-if="row.status >= 3"
                        type="info"
                        size="small"
                        :icon="Printer"
                        @click="printDeviceLabel(row)"
                      >
                        ÊâìÂç∞Ê†áÁ≠æ
                      </el-button>
                    </el-button-group>

                    <el-button
                      type="primary"
                      link
                      :icon="View"
                      @click="viewDetail(row)"
                      size="small"
                      class="ml-2"
                    >
                      Êü•ÁúãËØ¶ÊÉÖ
                    </el-button>
                  </template>
                </el-table-column>
              </el-table>

              <!-- ÊâπÈáèÊìç‰ΩúÊåâÈíÆ -->
              <div
                class="flex justify-end mt-3"
                v-if="
                  selectedDevices[row.id] &&
                  selectedDevices[row.id].length > 0 &&
                  row.status == 4
                "
              >
                <el-button-group>
                  <el-button
                    type="primary"
                    size="small"
                    :icon="Check"
                    @click="batchRecycleDevices(row.id)"
                  >
                    ÊâπÈáèÁ°ÆËÆ§ ({{ selectedDevices[row.id].length }})
                  </el-button>
                </el-button-group>
              </div>
            </div>
          </template>
        </el-table-column>

        <el-table-column label="ËÆ¢Âçï‰ø°ÊÅØ" min-width="200">
          <template #default="{ row }">
            <div class="order-info-cell">
              <div class="info-row">
                <span class="label">ËÆ¢ÂçïÂè∑Ôºö</span>
                <span class="value">{{ row.order_no }}</span>
              </div>
              <div class="info-row">
                <span class="label">ÈÖçÈÄÅÔºö</span>
                <span class="value">
                  <el-tag
                    size="small"
                    :type="row.delivery_type === '1' ? 'warning' : 'success'"
                  >
                    {{ row.delivery_type === "1" ? "üì¶ Âø´ÈÄí" : "üöó Ëá™ÈÄÅ" }}
                  </el-tag>
                </span>
              </div>
              <div v-if="row.delivery_type === '1'" class="info-row">
                <span class="text-gray-500 text-xs min-w-16">Âø´ÈÄíÂçïÂè∑Ôºö</span>
                <span 
                  class="flex-1 cursor-pointer transition-all duration-300 ease-in-out rounded px-1 py-0.5 hover:bg-blue-50 hover:text-blue-600 text-gray-800 text-sm break-all"
                  @click="handleExpressHover(row)"
                  @mouseleave="handleExpressLeave"
                >
                  <span v-if="!expressLoading[row.id]" class="font-mono font-medium">
                    {{ row.express_no || "ÊöÇÊó†" }}
                  </span>
                  <el-icon v-else class="animate-spin text-blue-500">
                    <Loading />
                  </el-icon>
                  <el-icon v-if="row.express_no && !expressLoading[row.id]" class="ml-1 text-gray-400 text-xs">
                    <Search />
                  </el-icon>
                </span>
              </div>
            </div>
          </template>
        </el-table-column>

        <el-table-column label="Áî®Êà∑‰ø°ÊÅØ" min-width="150">
          <template #default="{ row }">
            <div class="user-info-cell">
              <div class="user-avatar">
                <el-avatar
                  :size="32"
                  :src="row.member?.headimg ? img(row.member.headimg) : ''"
                  class="mr-2"
                >
                  <el-icon><User /></el-icon>
                </el-avatar>
              </div>
              <div class="user-details">
                <div class="user-name">
                  {{
                    row.recycleUserAddress?.name ||
                    row.member?.nickname ||
                    "Êú™Áü•Áî®Êà∑"
                  }}
                </div>
                <div class="user-phone">
                  {{
                    row.member?.mobile ||
                    row.recycleUserAddress?.mobile ||
                    "ÊöÇÊó†ËÅîÁ≥ªÊñπÂºè"
                  }}
                </div>
              </div>
            </div>
          </template>
        </el-table-column>

        <el-table-column width="140" align="center">
            <template #header>
                <div class="text-xs">Êèê‰∫§Êï∞Èáè/Á≠æÊî∂Êï∞Èáè</div>
            </template>
          <template #default="{ row }">
        
            <el-tag v-if="row.count == getDeviceCount(row.devices) " type="success" class="device-count-tag">
                {{ row.count  }}/
              {{ getDeviceCount(row.devices) }}Âè∞
            </el-tag>
            <el-tag v-else type="danger" class="device-count-tag">
              {{ row.count ? row.count : '1' }}/
              {{ getDeviceCount(row.devices) }}Âè∞
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column label="Áä∂ÊÄÅ" width="120" align="center">
          <template #default="{ row }">
            <el-tag
              :type="getStatusType(row.status)"
              :effect="getStatusEffect(row.status)"
            >
              <el-icon class="mr-1">
                <component :is="getStatusIcon(row.status)" />
              </el-icon>
              {{ row.status_name }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="create_at" label="ÂàõÂª∫Êó∂Èó¥" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.create_at) }}
          </template>
        </el-table-column>
        
        <el-table-column prop="sign_at" label="Á≠æÊî∂Êó∂Èó¥" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.sign_at) }}
          </template>
        </el-table-column>
        
        <el-table-column prop="complete_at" label="ÂÆåÊàêÊó∂Èó¥" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.complete_at) }}
          </template>
        </el-table-column>
        
        <el-table-column prop="pay_time" label="ÊâìÊ¨æÊó∂Èó¥" width="180">
          <template #default="{ row }">
            {{ formatDateTime(row.pay_time) }}
          </template>
        </el-table-column>

        <el-table-column label="Êìç‰Ωú" width="200" fixed="right">
          <template #default="{ row }">
            <el-button-group v-if="orderStatusMap[row.status]?.action">
              <el-button
                v-for="action in orderStatusMap[row.status].action"
                :key="action.key"
                size="small"
                :type="getActionButtonType(action.key)"
                :icon="getActionIcon(action.key)"
                @click="handleAction(row, action)"
              >
                {{ action.value }}
              </el-button>
            </el-button-group>
          </template>
        </el-table-column>
      </el-table>

      <!-- ÂàÜÈ°µ -->
      <div class="flex justify-between items-center mt-4">
        <div class="text-sm text-gray-500">
          ÂÖ± {{ pagination.total }} Êù°ËÆ∞ÂΩïÔºåÂΩìÂâçÁ¨¨ {{ pagination.page }} È°µ
        </div>
     
        <el-pagination
          v-model:current-page="pagination.page"
          :page-sizes="[15, 30, 50, 100]"
          :page-size="pagination.limit"
          :total="pagination.total"
          :hide-on-single-page="false"
          layout="  sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>

    <!-- ‰ΩøÁî®‰ª£‰∏ãÂçïÂºπÁ™óÁªÑ‰ª∂ -->
    <AddOrderDialog
      v-model:visible="addOrderDialogVisible"
      @success="handleAddOrderSuccess"
    />

    <!-- ËÆæÂ§á‰ø°ÊÅØÁ°ÆËÆ§ÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    <DeviceConfirmDialog
      v-model:visible="orderDialogVisible"
      :device-list="currentDevices"
      :order-id="currentOrderId"
      @confirm="handleDeviceConfirm"
      @add-device="addDevice"
      @edit-device="editDevice"
      @remove-device="removeDevice"
      @cancel="cancelDeviceEdit"
    />

    <!-- Ê∑ªÂä†Êñ∞ÁöÑË¥®Ê£ÄÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    <CheckDeviceDialog
      v-model:visible="checkDeviceLogVisible"
      :device="checkDeviceLogForm"
      @confirm="submitDeviceCheck"
    />

    <PriceFormDialog
      v-model:visible="priceDeviceLogVisible"
      :device="checkDeviceLogForm"
      @confirm="submitDevicePrice"
    />

    <!-- ‰ΩøÁî®ËÆæÂ§áËØ¶ÊÉÖÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    <DeviceDetailDialog
      v-model:visible="deviceLogVisible"
      :device="deviceDetailData"
      @closed="handleDeviceDetailClosed"
    />

    <!-- ËÆ¢ÂçïËØ¶ÊÉÖ -->
    <OrderDetailDialog
      v-model:visible="orderDetailVisible"
      :order-detail="orderDetail"
    />
    <!-- ÊîØ‰ªòÊñπÂºè -->
    <PaymentMethodDialog
      v-model:visible="paymentDialogVisible"
      :payment-info="paymentInfo"
      @payment-confirmed="handlePaymentConfirm"
    />

    <!-- Âø´ÈÄí‰ø°ÊÅØÂºπÂá∫Ê°Ü -->
    <el-dialog 
      v-model="expressPopoverVisible" 
      title="Âø´ÈÄíÁâ©ÊµÅ‰ø°ÊÅØ" 
      width="600px"
      :destroy-on-close="true"
    >
      <div v-if="expressInfo" class="express-info-container">
        <!-- Âø´ÈÄíÂü∫Êú¨‰ø°ÊÅØ -->
        <div class="express-header mb-4">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-medium">{{ expressInfo.logisticsCompanyName }}</h3>
              <p class="text-sm text-gray-600">ËøêÂçïÂè∑Ôºö{{ expressInfo.mailNo }}</p>
            </div>
            <el-tag 
              :type="getExpressStatusType(expressInfo.logisticsStatus)"
              size="large"
            >
              {{ expressInfo.logisticsStatusDesc }}
            </el-tag>
          </div>
          <div class="mt-2">
            <p class="text-sm text-gray-600">
              ÊúÄÊñ∞Áä∂ÊÄÅÔºö{{ expressInfo.theLastMessage }}
            </p>
            <p class="text-xs text-gray-500">
              Êõ¥Êñ∞Êó∂Èó¥Ôºö{{ expressInfo.theLastTime }}
            </p>
          </div>
        </div>

        <!-- Áâ©ÊµÅËΩ®Ëøπ -->
        <div class="express-trace">
          <h4 class="text-md font-medium mb-3">Áâ©ÊµÅËΩ®Ëøπ</h4>
          <el-timeline>
            <el-timeline-item
              v-for="(item, index) in expressInfo.logisticsTraceDetailList"
              :key="index"
              :timestamp="item.timeDesc"
              :type="index === 0 ? 'primary' : 'info'"
              :size="index === 0 ? 'large' : 'normal'"
            >
              <div class="trace-item">
                <div class="trace-location">{{ item.areaName }}</div>
                <div class="trace-desc">{{ item.desc }}</div>
              </div>
            </el-timeline-item>
          </el-timeline>
        </div>
      </div>
      
      <div v-else class="text-center py-8 text-gray-500">
        ÊöÇÊó†Âø´ÈÄí‰ø°ÊÅØ
      </div>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, nextTick, watch, computed } from "vue";
import {
  ElMessage,
  ElMessageBox,
  ElLoading,
  ElNotification,
} from "element-plus";
import {
  Plus,
  Search,
  Refresh,
  ArrowDown,
  ArrowUp,
  Document,
  DocumentChecked,
  PriceTag,
  Check,
  Edit,
  Close,
  Printer,
  View,
  User,
  Clock,
  ShoppingBag,
  QuestionFilled,
  SuccessFilled,
  WarningFilled,
  CircleClose,
  InfoFilled,
  Filter,
  Download,
  Loading,
  Bell,
} from "@element-plus/icons-vue";
import { usePageState } from "../../hooks/usePageState";
// Ë∑ØÁî±
import { useRoute } from "vue-router";
const route = useRoute();

import {
  getRecycleOrderList,
  getRecycleOrderStatusList,
  updateRecycleOrder,
  getRecycleOrderInfo,
  // ÂÆö‰ª∑
  confirmPrice,
  getDevice,
  updateDevice,
  getMerchantPayInfo,
  paymentConfirm,
  batchRecycleDevices as apiBatchRecycleDevices,
  batchReturnDevices as apiBatchReturnDevices,
  deleteRecycleOrder,
  deleteRecycleDevice,
  pushOrderNotify, // Êé®ÈÄÅÈÄöÁü•API
} from "@/addon/recycle/api/recycle_order";
import { getExpress } from "@/addon/recycle/api/device_query_api";

// ÂØºÂÖ•ÊâìÂç∞API
import { _printDeviceLabel } from "@/addon/recycle/api/printer";

// ÂØºÂÖ•‰ª£‰∏ãÂçïÂºπÁ™óÁªÑ‰ª∂
import AddOrderDialog from "./components/AddOrderDialog.vue";
// ÂØºÂÖ•ËÆæÂ§áÂàóË°®ÂºπÁ™óÁªÑ‰ª∂
// import DeviceListDialog from './components/DeviceListDialog.vue'
// ÂØºÂÖ•ËÆæÂ§áËØ¶ÊÉÖÂºπÁ™óÁªÑ‰ª∂
// import DeviceDetailDialog from './components/DeviceDetailDialog.vue'
// ÂØºÂÖ•Êñ∞ÁöÑÊîØ‰ªòÊñπÂºèÂØπËØùÊ°ÜÁªÑ‰ª∂
import PaymentMethodDialog from "./components/PaymentMethodDialog.vue";
// ÂØºÂÖ•ËÆ¢ÂçïËØ¶ÊÉÖÂºπÁ™óÁªÑ‰ª∂
import OrderDetailDialog from "./components/OrderDetailDialog.vue";
// ÂØºÂÖ•ÂÆö‰ª∑Ë°®ÂçïÁªÑ‰ª∂
import PriceFormDialog from "./components/PriceFormDialog.vue";
import CheckDeviceDialog from "./components/CheckDeviceDialog.vue";
// ÂØºÂÖ•ËÆæÂ§áÁ°ÆËÆ§ÂØπËØùÊ°ÜÁªÑ‰ª∂
import DeviceConfirmDialog from "./components/DeviceConfirmDialog.vue";
// ÂØºÂÖ•ËÆæÂ§áËØ¶ÊÉÖÂØπËØùÊ°ÜÁªÑ‰ª∂
import DeviceDetailDialog from "./components/DeviceDetailDialog.vue";

import MemberSelect from "@/addon/recycle/components/member-select/index.vue";


// ÂºïÂÖ•ÂõæÁâáÈ¢ÑËßàÂ∑•ÂÖ∑
import { img, debounce } from "@/utils/common";

// Áä∂ÊÄÅÂÆö‰πâ
interface OrderStatus {
  name: string;
  status: number;
  action: string[];
}

// ËÆ¢ÂçïÂàóË°®È°πÂÆö‰πâ
interface OrderItem {
  id: number;
  status: number;
  status_name: string;
  delivery_type: string;
  delivery_type_name: string;
  express_no: string;
  create_at: string;
  update_at: string;
  devices: any[];
  member: {
    member_id: number;
    nickname: string;
    mobile: string;
    headimg: string;
  };
}

// ÂàÜÈ°µÂèÇÊï∞
interface Pagination {
  page: number;
  limit: number;
  total: number;
}

// ÂÆö‰πâËÆ¢ÂçïËØ¶ÊÉÖÁ±ªÂûã
interface OrderDetail {
  id: number | string;
  status: number;
  status_name: string;
  customer_name?: string;
  customer_phone?: string;
  pay_type?: string;
  total_amount?: number | string;
  delivery_type_name?: string;
  express_company?: string;
  express_no?: string;
  device_count?: number;
  create_at?: string;
  update_at?: string;
  sign_at?: string;
  complete_at?: string;
  pay_time?: string;
  remark?: string;
  member?: {
    member_id: number | string;
    username?: string;
    nickname?: string;
    mobile?: string;
  };
  devices?: any[];
  [key: string]: any;
}

// Áä∂ÊÄÅÁÆ°ÁêÜ
const orderStatusMap = ref<Record<string, OrderStatus>>({});
const loading = ref(false);
const list = ref<OrderItem[]>([]);

// ÂàÜÈ°µ
const {
  expandedRows,
  pagination,
  setExpandedRows,
  setPagination,
  applyExpandedRows,
} = usePageState("recycle_order_list");

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÁ°Æ‰øùÂ±ïÂºÄË°åÈîÆÊòØÊ≠£Á°ÆÁöÑÊ†ºÂºè
const expandRowKeys = computed(() => {
  return expandedRows.value || [];
});

// Êó∂Èó¥Ê†ºÂºèÂåñÂáΩÊï∞
const formatDateTime = (dateTime: string | number | null | undefined): string => {
  if (!dateTime) return '-';
  
  // Â¶ÇÊûúÊòØÊó∂Èó¥Êà≥ÔºàÊï∞Â≠óÔºâ
  if (typeof dateTime === 'number') {
    const date = new Date(dateTime * 1000);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    }).replace(/\//g, '-');
  }
  
  // Â¶ÇÊûúÊòØÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
  if (typeof dateTime === 'string') {
    // Â¶ÇÊûúÂ∑≤ÁªèÊòØÊ†ºÂºèÂåñÁöÑÊó•ÊúüÊó∂Èó¥Â≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•ËøîÂõû
    if (dateTime.match(/^\d{4}-\d{2}-\d{2}/)) {
      return dateTime;
    }
  }
  
  return '-';
};

const orderDialogVisible = ref(false);
const paymentDialogVisible = ref(false);
const currentOrderId = ref<number | string>(0);
const currentDevices = ref<any[]>([]);
const orderDetailVisible = ref(false);
const orderDetail = ref<OrderDetail | null>(null);
const originalDevices = ref<any[]>([]);
const paymentInfo = ref<any[]>([]);
const selectedPayTypeIndex = ref(0);

// Âø´ÈÄí‰ø°ÊÅØÁõ∏ÂÖ≥
const expressLoading = ref<Record<string, boolean>>({});
const expressPopoverVisible = ref(false);
const expressInfo = ref<any>(null);
const currentExpressRow = ref<any>(null);
const hoverTimer = ref<any>(null);

// ËÆæÂ§áÁÆ°ÁêÜÁõ∏ÂÖ≥
const openDeviceDialog = async (orderId: number | string) => {
  currentOrderId.value = orderId;

  try {
    const res = await getRecycleOrderInfo(orderId);
    if (res.code === 1) {
      // Â∞ÜËÆæÂ§áÂàóË°®Êï∞ÊçÆÊ†áËÆ∞‰∏∫ÈùûÁºñËæëÁä∂ÊÄÅ
      currentDevices.value = res.data.devices.map((device: any) => ({
        ...device,
        editing: false,
      }));
      originalDevices.value = JSON.parse(JSON.stringify(currentDevices.value));
      orderDialogVisible.value = true;
    } else {
      ElMessage.error(res.message || "Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•");
    }
  } catch (error: any) {
    console.error("Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•Ôºö", error);
    ElMessage.error("Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•Ôºö" + (error.message || "Êú™Áü•ÈîôËØØ"));
  }
};

// Ê∑ªÂä†ËÆæÂ§á
const addDevice = () => {
  // Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ËÆæÂ§áÂà∞ÂàóË°®‰∏≠
  currentDevices.value.push({
    imei: "",
    model: "",
    initial_price: 0,
    editing: true,
    category_id: 1,
  });
};

// ÁºñËæëËÆæÂ§á
const editDevice = (row: any) => {
  // Êü•ÊâæËÆæÂ§áÂπ∂ËÆæÁΩÆ‰∏∫ÁºñËæëÁä∂ÊÄÅ
  const index = currentDevices.value.findIndex(
    (item) => item === row || item.id === row.id
  );
  if (index !== -1) {
    currentDevices.value[index].editing = true;
  }
};

// Âà†Èô§ËÆæÂ§á
const removeDevice = async (row: any) => {
  try {
    // ‰ªÖÂ§ÑÁêÜÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÁöÑËÆæÂ§áÔºàÊúâIDÁöÑËÆæÂ§áÔºâ
    if (row.id) {
      await deleteRecycleDevice(row.id);
      ElMessage.success("Âà†Èô§ÊàêÂäü");
      await getList();
      orderDialogVisible.value = false;
    }

    // ÂêåÊó∂‰ªéÁà∂ÁªÑ‰ª∂ÁöÑËÆæÂ§áÂàóË°®‰∏≠ÁßªÈô§ËØ•ËÆæÂ§áÔºàÂ§ÑÁêÜÊú¨Âú∞ËÆæÂ§áÂíåÂ∑≤‰øùÂ≠òËÆæÂ§áÔºâ
    currentDevices.value = currentDevices.value.filter(
      (item) => item !== row && item.id !== row.id
    );

  } catch (error: any) {
    console.error("Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö", error);
    ElMessage.error("Âà†Èô§Â§±Ë¥•Ôºö" + (error.message || "Êú™Áü•ÈîôËØØ"));
  }
};

// ÂèñÊ∂àËÆæÂ§áÁºñËæë
const cancelDeviceEdit = () => {
  orderDialogVisible.value = false;
  // Ê∏ÖÁ©∫ÂΩìÂâçËÆæÂ§áÂàóË°®
  currentDevices.value = [];
  currentOrderId.value = 0;
};

// Âø´ÈÄüÊêúÁ¥¢Ë°®Âçï
const quickSearchForm = reactive({
  keyword: "",
  status: "",
  delivery_type: "",
});

// È´òÁ∫ßÊêúÁ¥¢Ë°®Âçï
const advancedSearchForm = reactive({
  order_id: "",
  express_no: "",
  status: [],
  member_id: "",
  user_mobile: "",
  delivery_type: [],
  device_imei: "",
  device_model: "",
  device_count_min: null,
  device_count_max: null,
  amount_min: null,
  amount_max: null,
  create_time_range: [],
  update_time_range: [],
  sign_at: [],
  complete_at: [],
  pay_time: [],
});

// ÊêúÁ¥¢ÊòæÁ§∫ÊéßÂà∂
const showAdvancedSearch = ref(true);

// Ëé∑ÂèñÁä∂ÊÄÅÂàóË°®
const loadStatusList = async () => {
  try {
    const res = await getRecycleOrderStatusList();
    if (res.code === 1) {
      orderStatusMap.value = res.data;
    }
  } catch (error) {
    console.error("Ëé∑ÂèñÁä∂ÊÄÅÂàóË°®Â§±Ë¥•:", error);
  }
};

// Ë°®Ê†ºref
const orderTable = ref(null);

// Ëé∑ÂèñÂàóË°®Êï∞ÊçÆ
const getList = async (page = 1) => {
  loading.value = true;

  try {
    // ÊûÑÂª∫ËØ∑Ê±ÇÂèÇÊï∞ÔºåËøáÊª§Á©∫ÂÄº
    const params: any = {
      page: pagination.value.page,
      limit: pagination.value.limit,
    };

    // Ê∑ªÂä†Âø´ÈÄüÊêúÁ¥¢ÂèÇÊï∞
    if (quickSearchForm.keyword) params.keyword = quickSearchForm.keyword;
    if (quickSearchForm.status) params.status = quickSearchForm.status;
    if (quickSearchForm.delivery_type)
      params.delivery_type = quickSearchForm.delivery_type;

    // Ê∑ªÂä†È´òÁ∫ßÊêúÁ¥¢ÂèÇÊï∞
    if (advancedSearchForm.order_id)
      params.order_id = advancedSearchForm.order_id;
    if (advancedSearchForm.express_no)
      params.express_no = advancedSearchForm.express_no;
    if (advancedSearchForm.status && advancedSearchForm.status.length > 0)
      params.status = advancedSearchForm.status.join(",");
    if (advancedSearchForm.member_id)
      params.member_id = advancedSearchForm.member_id;
    if (advancedSearchForm.user_mobile)
      params.user_mobile = advancedSearchForm.user_mobile;
    if (
      advancedSearchForm.delivery_type &&
      advancedSearchForm.delivery_type.length > 0
    )
      params.delivery_type = advancedSearchForm.delivery_type.join(",");
    if (advancedSearchForm.device_imei)
      params.device_imei = advancedSearchForm.device_imei;
    if (advancedSearchForm.device_model)
      params.device_model = advancedSearchForm.device_model;
    if (advancedSearchForm.device_count_min)
      params.device_count_min = advancedSearchForm.device_count_min;
    if (advancedSearchForm.device_count_max)
      params.device_count_max = advancedSearchForm.device_count_max;
    if (advancedSearchForm.amount_min)
      params.amount_min = advancedSearchForm.amount_min;
    if (advancedSearchForm.amount_max)
      params.amount_max = advancedSearchForm.amount_max;
    if (
      advancedSearchForm.create_time_range &&
      advancedSearchForm.create_time_range.length === 2
    ) {
      params.create_time_start = advancedSearchForm.create_time_range[0];
      params.create_time_end = advancedSearchForm.create_time_range[1];
    }
    if (
      advancedSearchForm.update_time_range &&
      advancedSearchForm.update_time_range.length === 2
    ) {
      params.update_time_start = advancedSearchForm.update_time_range[0];
      params.update_time_end = advancedSearchForm.update_time_range[1];
    }
    // ÊâìÊ¨æÊó∂Èó¥
    if (advancedSearchForm.pay_time && advancedSearchForm.pay_time.length === 2) {
      params.pay_time = advancedSearchForm.pay_time;
    }
    // Á≠æÊî∂Êó∂Èó¥
    if (advancedSearchForm.sign_at && advancedSearchForm.sign_at.length === 2) {
      params.sign_at = advancedSearchForm.sign_at;
    }
    // ÂÆåÊàêÊó∂Èó¥
    if (advancedSearchForm.complete_at && advancedSearchForm.complete_at.length === 2) {
      params.complete_at = advancedSearchForm.complete_at;
    }

    const res = await getRecycleOrderList(params);

    // Ê†πÊçÆÂÆûÈôÖAPIËøîÂõûÁªìÊûÑË∞ÉÊï¥
    if (res.data.data) {
      list.value = res.data.data;
    } else if (res.data.list) {
      list.value = res.data.list;
    } else {
      list.value = [];
      console.error("APIËøîÂõûÁöÑÊï∞ÊçÆÁªìÊûÑ‰∏çÁ¨¶ÂêàÈ¢ÑÊúü:", res.data);
    }
    // Â§ÑÁêÜ‰∏çÂêåÁöÑÂàÜÈ°µÊï∞ÊçÆÁªìÊûÑ
    const total = res.data.total || res.data.count || 0;
    // status_counts
    statusCounts.value = res.data.status_counts;

    setPagination({
      total
    });

    // ‰∏çÈúÄË¶ÅÊâãÂä®Â±ïÂºÄË°å‰∫ÜÔºåÂõ†‰∏∫Êàë‰ª¨‰ΩøÁî®‰∫Ü:expand-row-keysÁªëÂÆö
  } catch (error) {
    console.error("Ëé∑ÂèñÂàóË°®Â§±Ë¥•:", error);
    ElMessage.error("Ëé∑ÂèñÂàóË°®Â§±Ë¥•");
  } finally {
    loading.value = false;
  }
};

const handleSizeChange = (val: number) => {
  // Êõ¥Êñ∞ÂàÜÈ°µÂ§ßÂ∞è
  setPagination({
    limit: val,
    page: pagination.value.page,
  });
  getList(1);
};

const handleCurrentChange = (val: number) => {
  // Êõ¥Êñ∞È°µÁ†Å
  setPagination({
    page: val,
    limit: pagination.value.limit,

  });
  getList(val);
};

// ÊêúÁ¥¢Èù¢ÊùøÊäòÂè†Áä∂ÊÄÅ
const searchPanelCollapsed = ref(false);

// Áä∂ÊÄÅÁªüËÆ°
const statusCounts = ref<Record<string, number>>({});

// Ëé∑ÂèñÁä∂ÊÄÅÊï∞Èáè
const getStatusCount = (status: string | number) => {
  if (status === "all") {
    return pagination.value.total;
  }
  return statusCounts.value[status] || 0;
};

// ‰ºòÂåñÁöÑÁä∂ÊÄÅÊ†áÁ≠æÁ±ªÂûã - ÈÅøÂÖçÈ¢úËâ≤ÂÜ≤Á™Å
const getStatusType = (status: number): string => {
  const typeMap: Record<number, string> = {
    1: "warning", // ÂæÖÁ≠æÊî∂ - Ê©ôËâ≤
    2: "warning", // Â∑≤Á≠æÊî∂ - ÈªòËÆ§ÁÅ∞Ëâ≤
    3: "primary", // Ë¥®Ê£Ä‰∏≠ - ËìùËâ≤
    4: "success", // Â∑≤Ë¥®Ê£Ä - ÁªøËâ≤
    5: "warning", // ÂæÖÁ°ÆËÆ§ - Ê©ôËâ≤
    6: "primary", // ÂæÖÊâìÊ¨æ - ËìùËâ≤
    7: "success", // Â∑≤ÂÆåÊàê - ÁªøËâ≤
    8: "info", // Â∑≤ÂÖ≥Èó≠ - ËìùËâ≤
    9: "danger", // Â∑≤ÂèñÊ∂à - Á∫¢Ëâ≤
    10: "danger", // Â∑≤Âà†Èô§ - Á∫¢Ëâ≤
  };
  return typeMap[status] || "info";
};

// Áä∂ÊÄÅÊïàÊûúÁ±ªÂûã
const getStatusEffect = (status: number): string => {
  const effectMap: Record<number, string> = {
    1: "light", // ÂæÖÁ≠æÊî∂
    2: "light", // Â∑≤Á≠æÊî∂
    3: "light", // Ë¥®Ê£Ä‰∏≠
    4: "light", // Â∑≤Ë¥®Ê£Ä
    5: "light", // ÂæÖÁ°ÆËÆ§
    6: "dark", // ÂæÖÊâìÊ¨æ
    7: "dark", // Â∑≤ÂÆåÊàê
    8: "plain", // Â∑≤ÂÖ≥Èó≠
    9: "dark", // Â∑≤ÂèñÊ∂à
    10: "dark", // Â∑≤Âà†Èô§
  };
  return effectMap[status] || "plain";
};

// ËÆæÂ§áÁä∂ÊÄÅÁ±ªÂûã
const getDeviceStatusType = (status: number): string => {
  const typeMap: Record<number, string> = {
    1: "info", // ÂæÖË¥®Ê£Ä
    2: "warning", // Ë¥®Ê£Ä‰∏≠
    3: "primary", // Â∑≤Ë¥®Ê£Ä
    4: "success", // Â∑≤ÂÆö‰ª∑
    5: "success", // Â∑≤Á°ÆËÆ§
    6: "danger", // Â∑≤ÈÄÄÂõû
  };
  return typeMap[status] || "info";
};

// Áä∂ÊÄÅÂõæÊ†á
const getStatusIcon = (status: number) => {
  switch (status) {
    case 1:
      return "Clock";
    case 2:
      return "Finished";
    case 3:
      return "Loading";
    case 4:
      return "DocumentChecked";
    case 5:
      return "CircleCheck";
    case 6:
      return "Money";
    case 7:
      return "CircleCheckFilled";
    case 8:
      return "CircleClose";
  
    default:
      return "QuestionFilled";
  }
};

// Áä∂ÊÄÅÂæΩÁ´†Á±ªÂûã
const getStatusBadgeType = (status: number): string => {
  const typeMap: Record<number, string> = {
    1: "warning", // ÂæÖÁ≠æÊî∂
    2: "info", // Â∑≤Á≠æÊî∂
    3: "primary", // Ë¥®Ê£Ä‰∏≠
    4: "success", // Â∑≤Ë¥®Ê£Ä
    5: "warning", // ÂæÖÁ°ÆËÆ§
    6: "primary", // ÂæÖÊâìÊ¨æ
    7: "success", // Â∑≤ÂÆåÊàê
    8: "info", // Â∑≤ÂÖ≥Èó≠
    9: "danger", // Â∑≤ÂèñÊ∂à
    10: "danger", // Â∑≤Âà†Èô§
  };
  return typeMap[status] || "info";
};

// Êìç‰ΩúÊåâÈíÆÁ±ªÂûã
const getActionButtonType = (actionKey: string): string => {
  const typeMap: Record<string, string> = {
    order_sign: "primary",
    order_check: "success",
    order_price: "warning",
    order_payment: "primary",
    order_complete: "success",
    order_cancel: "danger",
    order_delete: "danger",
    order_detail: "info",
  };
  return typeMap[actionKey] || "default";
};

// Êìç‰ΩúÊåâÈíÆÂõæÊ†á
const getActionIcon = (actionKey: string) => {
  const iconMap: Record<string, any> = {
    order_sign: DocumentChecked,
    order_check: Search,
    order_price: PriceTag,
    order_payment: ShoppingBag,
    order_complete: SuccessFilled,
    order_cancel: CircleClose,
    order_delete: Close,
    order_detail: View,
    order_push_notify: Bell, // Êé®ÈÄÅÈÄöÁü•ÂõæÊ†á
  };
  return iconMap[actionKey] || InfoFilled;
};

// Ê†ºÂºèÂåñ‰ª∑Ê†º
const formatPrice = (price: number | string): string => {
  if (!price) return "¬•0.00";
  const num = typeof price === "string" ? parseFloat(price) : price;
  return `¬•${num.toFixed(2)}`;
};

// Â§ÑÁêÜÊé®ÈÄÅÈÄöÁü•
const handlePushNotify = async (row: any) => {
  try {
    await ElMessageBox.confirm("Á°ÆÂÆöË¶ÅÊé®ÈÄÅËÆ¢ÂçïÁ°ÆËÆ§ÈÄöÁü•ÁªôÁî®Êà∑ÂêóÔºü", "Êé®ÈÄÅÈÄöÁü•", {
      confirmButtonText: "Á°ÆÂÆöÊé®ÈÄÅ",
      cancelButtonText: "ÂèñÊ∂à",
      type: "info",
    });

    const loading = ElLoading.service({
      lock: true,
      text: "Ê≠£Âú®ÂèëÈÄÅÈÄöÁü•...",
      background: "rgba(0, 0, 0, 0.7)",
    });

    // Ë∞ÉÁî®Êé®ÈÄÅÈÄöÁü•API
    await pushOrderNotify(row.id);
    
    loading.close();
    ElMessage.success("Êé®ÈÄÅÈÄöÁü•Â∑≤ÂèëÈÄÅ");
  } catch (error: any) {
    if (error !== "cancel") {
      console.error("Êé®ÈÄÅÈÄöÁü•Â§±Ë¥•Ôºö", error);
      ElMessage.error(error.message || "Êé®ÈÄÅÈÄöÁü•Â§±Ë¥•");
    }
  }
};

// Â§ÑÁêÜËÆ¢ÂçïÊìç‰Ωú
const handleAction = async (row, action) => {
  try {
    // Ê†πÊçÆÊìç‰ΩúÁ±ªÂûãÊâßË°å‰∏çÂêåÁöÑÊìç‰Ωú
    if (action.key === "order_cancel") {
      // ÂèñÊ∂àËÆ¢Âçï
      await ElMessageBox.confirm("Á°ÆÂÆöË¶ÅÂèñÊ∂àËØ•ËÆ¢ÂçïÂêóÔºü", "ÊèêÁ§∫", {
        confirmButtonText: "Á°ÆÂÆö",
        cancelButtonText: "ÂèñÊ∂à",
        type: "warning",
      });

      // ‰ΩøÁî®action.key‰Ωú‰∏∫Êìç‰ΩúÊ†áËØÜ
      await updateRecycleOrder(row.id, { action: "order_cancel" });
      ElMessage.success("ËÆ¢ÂçïÂ∑≤ÂèñÊ∂à");
      await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
    } else if (action.key === "order_delete") {
      // Âà†Èô§ËÆ¢Âçï
      await ElMessageBox.confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ËÆ¢ÂçïÂêóÔºü", "ÊèêÁ§∫", {
        confirmButtonText: "Á°ÆÂÆö",
        cancelButtonText: "ÂèñÊ∂à",
        type: "warning",
      });
      await deleteRecycleOrder(row.id);
      ElMessage.success("ËÆ¢ÂçïÂ∑≤Âà†Èô§");
      await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
    } else if (action.key === "order_complete") {
      // ÂÆåÊàêËÆ¢Âçï
      await ElMessageBox.confirm("Á°ÆÂÆöË¶ÅÂÆåÊàêËØ•ËÆ¢ÂçïÂêóÔºü", "ÊèêÁ§∫", {
        confirmButtonText: "Á°ÆÂÆö",
        cancelButtonText: "ÂèñÊ∂à",
        type: "warning",
      });

      // ‰ΩøÁî®action.key‰Ωú‰∏∫Êìç‰ΩúÊ†áËØÜ
      await updateRecycleOrder(row.id, { action: "order_complete" });
      ElMessage.success("Êìç‰ΩúÊàêÂäüÔºåËÆ¢ÂçïÂ∑≤ÂÆåÊàê");
      await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
    } else if (action.key === "order_sign") {
      // Á≠æÊî∂ËÆ¢Âçï
      currentOrderId.value = row.id;
      currentDevices.value = row.devices || [];
      orderDialogVisible.value = true;
    } else if (action.key === "order_check") {
      // Ë¥®Ê£ÄËÆ¢Âçï
      currentOrderId.value = row.id;
      currentDevices.value = row.devices || [];
      checkDeviceLogVisible.value = true;
    } else if (action.key === "order_price") {
      // ÂÆö‰ª∑ËÆ¢Âçï
      currentOrderId.value = row.id;
      currentDevices.value = row.devices || [];
      priceDeviceLogVisible.value = true;
    } else if (action.key == "order_payment") {
      // Á°ÆËÆ§ÊâìÊ¨æ Ââç Â∞ÜÁî®Êà∑ÁöÑÊî∂Ê¨æÊñπÂºè ÂºπÂá∫Êù• Â±ïÁ§∫ÁªôË¥¢Âä°Áúã , Ë¥¢Âä°ÊâìÂÆåÊ¨æÂêé ÁÇπÂáªÁ°ÆÂÆöÊåâÈíÆ , ÂÆåÊàêÊâìÊ¨æ
      // row.member_id ÈúÄÊê∫Â∏¶

      paymentDialogVisible.value = true;

      const res = await getMerchantPayInfo(row.member_id);
      if (res.data && Array.isArray(res.data)) {
        // Ëé∑ÂèñÂΩìÂâçËÆ¢ÂçïÁöÑÊÄªÊï∞ÊçÆ
        const order = list.value.find((item) => item.id === row.id);

        // ËÆ°ÁÆóÈÄÄÂõûÁöÑËÆæÂ§áÊï∞Èáè
        let returnedDeviceCount = 0;
        if (order && order.devices && Array.isArray(order.devices)) {
          returnedDeviceCount = order.devices.filter(
            (device) => device.status === 6
          ).length;
        }
        // ËÆ°ÁÆóÂ∑≤Ë¥®Ê£ÄÁöÑËÆæÂ§áÊï∞Èáè
        let checkedDeviceCount = 0;
        if (order && order.devices && Array.isArray(order.devices)) {
          checkedDeviceCount = order.devices.filter(
            (device) => device.status >= 4
          ).length;
        }

        // ËÆ°ÁÆóÂ∑≤Á°ÆËÆ§ÁöÑËÆæÂ§áÊï∞Èáè
        let confirmedDeviceCount = 0;
        if (order && order.devices && Array.isArray(order.devices)) {
          confirmedDeviceCount = order.devices.filter(
            (device) => device.status >= 5
          ).length;
        }
        // ËÆ°ÁÆóÊàêÂäüÂõûÊî∂ÁöÑËÆæÂ§áÊï∞Èáè
        let successDeviceCount = 0;
        if (order && order.devices && Array.isArray(order.devices)) {
          successDeviceCount = order.devices.filter(
            (device) => device.status == 5
          ).length;
        }

        // ËÆ°ÁÆóÊâÄÊúâËÆæÂ§á Âπ∂‰∏îÂêåÊÑèÂõûÊî∂ÁöÑ ÊúÄÁªà‰ª∑Ê†º
        let finalPrice = 0;
        if (order && order.devices && Array.isArray(order.devices)) {
          finalPrice = order.devices
            .filter((device) => device.status == 5)
            .reduce((sum, device) => sum + +device.final_price, 0);
        }

        // ÂáÜÂ§áËÆ¢ÂçïÊëòË¶Å‰ø°ÊÅØ
        const orderSummary = {
          order_id: order ? order.id : row.id,
          delivery_type: order ? order.delivery_type_text : "",
          device_count: order && order.devices ? order.devices.length : 0,
          confirmed_count: confirmedDeviceCount,
          checked_count: checkedDeviceCount,
          success_count: successDeviceCount,
          returned_count: returnedDeviceCount,
          price_per_device: order ? order.price_per_device : 0,
          total_amount: order ? finalPrice : 0,
          customer_name: order ? order.member.nickname : "",
          customer_mobile: order ? order.member.mobile : "",
          delivery_type_name: order ? order.delivery_type_name : "",
          // Ê∑ªÂä†ËÆæÂ§áËØ¶ÊÉÖÂàóË°®
          devices:
            order && order.devices
              ? order.devices.map((device) => ({
                  id: device.id,
                  model: device.model,
                  imei: device.imei,
                  final_price: device.final_price || 0,
                  status: device.status,
                  status_name: device.status_name || "",
                }))
              : [],
        };

        // Â∞ÜËÆ¢ÂçïÊëòË¶Å‰ø°ÊÅØÊ∑ªÂä†Âà∞ÊØè‰∏™ÊîØ‰ªòÊñπÂºè‰∏≠
        const paymentInfoWithOrder = res.data.map((item) => {
          return {
            ...item,
            order_summary: orderSummary,
          };
        });

        paymentInfo.value = paymentInfoWithOrder;

        // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™
        selectedPayTypeIndex.value = paymentInfoWithOrder.length > 0 ? 0 : -1;
      } else {
        paymentInfo.value = [];
      }
    } else if (action.key == "order_detail") {
      // Êü•ÁúãËØ¶ÊÉÖ
      const order = list.value.find((item) => item.id === row.id);

      if (order) {
        orderDetail.value = order as OrderDetail;
        orderDetailVisible.value = true;
      } else {
        ElMessage.warning("Êú™ÊâæÂà∞ËÆ¢Âçï‰ø°ÊÅØ");
      }
    } else if (action.key == "order_push_notify") {
      // Êé®ÈÄÅÈÄöÁü• - ÊèêÈÜíÁî®Êà∑Á°ÆËÆ§ËÆ¢Âçï
      await handlePushNotify(row);
    } else {
      // ÂÖ∂‰ªñÊìç‰Ωú - ‰ΩøÁî®action.key‰Ωú‰∏∫Êìç‰ΩúÊ†áËØÜ
      await updateRecycleOrder(row.id, { action: action.key });
      ElMessage.success("Êìç‰ΩúÊàêÂäü");
      await getList(); // Âà∑Êñ∞ÂàóË°®
    }
  } catch (error) {
    console.error("Êìç‰ΩúÂ§±Ë¥•Ôºö", error);
    ElMessage.error(error.message || "Êìç‰ΩúÂ§±Ë¥•");
  }
};

// Ëé∑ÂèñËÆæÂ§áÊï∞Èáè
const getDeviceCount = (devices: any[]) => {
  if (!devices) return 0;
  return devices.length;
};

// Âø´ÈÄüÊêúÁ¥¢
const quickSearch = () => {
  // Ê∏ÖÁ©∫È´òÁ∫ßÊêúÁ¥¢Êù°‰ª∂
  resetAdvancedSearchForm();
  // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  setPagination({ page: 1 });
  getList(1);
};

// ÈáçÁΩÆÂø´ÈÄüÊêúÁ¥¢
const resetQuickSearch = () => {
  quickSearchForm.keyword = "";
  quickSearchForm.status = "";
  quickSearchForm.delivery_type = "";
  activeTab.value = "";
  // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  setPagination({ page: 1 });
  getList(1);
};

// È´òÁ∫ßÊêúÁ¥¢
const advancedSearch = () => {
  // Ê∏ÖÁ©∫Âø´ÈÄüÊêúÁ¥¢Êù°‰ª∂
  resetQuickSearchForm();
  // Ê∏ÖÁ©∫Ê†áÁ≠æÈ°µÁä∂ÊÄÅ
  activeTab.value = "";
  // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  setPagination({ page: 1 });
  getList(1);
};

// ÈáçÁΩÆÈ´òÁ∫ßÊêúÁ¥¢
const resetAdvancedSearch = () => {
  resetAdvancedSearchForm();
  // Ê∏ÖÁ©∫Ê†áÁ≠æÈ°µÁä∂ÊÄÅ
  activeTab.value = "";
  // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  setPagination({ page: 1 });
  getList(1);
};

// ÈáçÁΩÆÂø´ÈÄüÊêúÁ¥¢Ë°®Âçï
const resetQuickSearchForm = () => {
  quickSearchForm.keyword = "";
  quickSearchForm.status = "";
  quickSearchForm.delivery_type = "";
};

// ÈáçÁΩÆÈ´òÁ∫ßÊêúÁ¥¢Ë°®Âçï
const resetAdvancedSearchForm = () => {
  advancedSearchForm.order_id = "";
  advancedSearchForm.express_no = "";
  advancedSearchForm.status = [];
  advancedSearchForm.member_id = "";
  advancedSearchForm.user_mobile = "";
  advancedSearchForm.delivery_type = [];
  advancedSearchForm.device_imei = "";
  advancedSearchForm.device_model = "";
  advancedSearchForm.device_count_min = null;
  advancedSearchForm.device_count_max = null;
  advancedSearchForm.amount_min = null;
  advancedSearchForm.amount_max = null;
  advancedSearchForm.create_time_range = [];
  advancedSearchForm.update_time_range = [];
  advancedSearchForm.sign_at = [];
  advancedSearchForm.complete_at = [];
  advancedSearchForm.pay_time = [];
};
const handleMemberChange = (memberId: number | null, memberInfo: any) => {
  advancedSearchForm.member_id = memberId;
  // ÂΩìÁî®Êà∑ÈÄâÊã©ÂèòÂåñÊó∂Ëá™Âä®ÊêúÁ¥¢
  setPagination({ page: 1 });
  getList(1);
};

// ÂØºÂá∫Êï∞ÊçÆ
const exportData = () => {
  ElMessage.info("ÂØºÂá∫ÂäüËÉΩÂºÄÂèë‰∏≠...");
};

// Ëé∑ÂèñËÆ¢ÂçïÁä∂ÊÄÅ
const findOrderStatus = (orderId: number) => {
  const order = list.value.find((item) => item.id === orderId);
  return order ? order.status : 0;
};

// Ë°®ÂçïÊï∞ÊçÆ
const checkDeviceLogForm = ref({
  id: 0,
  imei: "",
  model: "",
  initial_price: "",
  check_result: "",
  check_images: "",
  remark: "",
  status: 0,
  final_price: "",
  check_status: 0,
});

// Ë°®ÂçïÈ™åËØÅËßÑÂàô
const checkDeviceLogRules = {
  check_result: [
    { required: true, message: "ËØ∑ËæìÂÖ•Ë¥®Ê£ÄÁªìÊûú", trigger: "blur" },
  ],
};

//checkDevice
const checkDeviceLogVisible = ref(false);
const priceDeviceLogVisible = ref(false);
const priceForm = ref({}); // Ê∑ªÂä†Á©∫ÁöÑpriceFormÂØπË±°

//editDevice
const checkDevice = async (row: any) => {
  // Êü•ÊâæÂΩìÂâçËÆæÂ§áÊâÄÂ±ûÁöÑËÆ¢Âçï
  const orderId = row.order_id;
  // Âú®list‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑËÆ¢Âçï
  const order = list.value.find((item) => item.id === orderId);

  // Â¶ÇÊûúËÆ¢ÂçïÁä∂ÊÄÅÊòØÂæÖÁ≠æÊî∂(1)ÔºåÂàôÊèêÁ§∫Áî®Êà∑ÂÖàÁ≠æÊî∂ËÆ¢Âçï
  if (order && order.status === 1) {
    ElMessage.warning("ËØ∑ÂÖàÁ≠æÊî∂ËÆ¢ÂçïÂêéÂÜçËøõË°åË¥®Ê£Ä");
    return;
  }

  checkDeviceLogVisible.value = true;
  const res = await getDevice(row.id);
  if (res.code === 1) {
    checkDeviceLogForm.value = {
      id: res.data.id,
      imei: res.data.imei,
      model: res.data.model,
      initial_price: res.data.initial_price,
      check_result: res.data.check_result || "",
      check_images: res.data.check_images || "",
      final_price: res.data.final_price || "",
      remark: res.data.remark || "",
      status: res.data.status,
      check_status: res.data.check_status,
    };
  }
};

const priceDevice = async (row: any) => {
  try {
    const res = await getDevice(row.id);
    if (res.code === 1) {
      checkDeviceLogForm.value = {
        id: res.data.id,
        imei: res.data.imei,
        model: res.data.model,
        initial_price: res.data.initial_price,
        check_result: res.data.check_result || "",
        check_images: res.data.check_images || "",
        final_price: res.data.final_price || "",
        before_price: res.data.before_price || "",
        remark: res.data.remark || "",
        status: res.data.status,
        check_status: res.data.check_status,
      };
      priceDeviceLogVisible.value = true;
    }
  } catch (error) {
    console.error("Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØÂ§±Ë¥•:", error);
    ElMessage.error("Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØÂ§±Ë¥•");
  }
};

// Êèê‰∫§ËÆæÂ§áË¥®Ê£Ä
const submitDeviceCheck = async (formData) => {
  try {
    // È™åËØÅÊï∞ÊçÆÊòØÂê¶ÂÆåÊï¥
    if (!formData.check_result) {
      ElMessage.warning("ËØ∑Â°´ÂÜôË¥®Ê£ÄÁªìÊûú");
      return;
    }

    await updateDevice(formData.id, {
      check_result: formData.check_result,
      check_images: formData.check_images,
      remark: formData.remark,
      check_status: 1, // Â∑≤Ë¥®Ê£Ä
      final_price: formData.final_price,
      action: "check", // Ê∑ªÂä†Êìç‰ΩúÁ±ªÂûãÔºåË°®Á§∫ËøôÊòØË¥®Ê£ÄÊìç‰Ωú
      imei: formData.imei,
      info: formData.info,
      model: formData.model,
    });

    ElMessage.success("Ë¥®Ê£Ä‰ø°ÊÅØÊèê‰∫§ÊàêÂäü");
    checkDeviceLogVisible.value = false;
    await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
  } catch (error) {
    console.error("Êèê‰∫§Ë¥®Ê£Ä‰ø°ÊÅØÂ§±Ë¥•Ôºö", error);
    // ÊòæÁ§∫ÂêéÁ´ØËøîÂõûÁöÑÂÖ∑‰ΩìÈîôËØØ‰ø°ÊÅØ
    ElMessage.error(error.response?.data?.message || "Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
  }
};

// Êèê‰∫§ËÆæÂ§áÂÆö‰ª∑
const submitDevicePrice = async (formData) => {
  try {
    // È™åËØÅ‰ª∑Ê†ºÊòØÂê¶ÊúâÊïà
    if (!formData || !formData.final_price || formData.final_price <= 0) {
      ElMessage.warning("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª∑Ê†º");
      return;
    }

    // Êèê‰∫§Êï∞ÊçÆ
    await confirmPrice(formData.id, formData);

    ElMessage.success("ÂÆö‰ª∑‰ø°ÊÅØÊèê‰∫§ÊàêÂäü");
    priceDeviceLogVisible.value = false;
    await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
  } catch (error) {
    console.error("Êèê‰∫§ÂÆö‰ª∑‰ø°ÊÅØÂ§±Ë¥•Ôºö", error);
    ElMessage.error("Êèê‰∫§Â§±Ë¥•ÔºåËØ∑ÈáçËØï");
  }
};

// ËÆæÂ§áÂ§öÈÄâ
const selectedDevices = ref({});

// ËÆæÂ§áÂ§öÈÄâÂèòÂåñ‰∫ã‰ª∂
const handleDeviceSelectionChange = (val, orderId) => {
  selectedDevices.value[orderId] = val;
};

// Âçï‰∏™Á°ÆËÆ§
const batchRecycleDevice = async (deviceId) => {
  if (!deviceId) {
    ElMessage.warning("ËØ∑ÈÄâÊã©ËÆæÂ§á");
  }

  try {
    await apiBatchRecycleDevices({ ids: deviceId + "", remark: "ÁÆ°ÁêÜÂëòÁ°ÆËÆ§" });
    getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
  } catch (error) {
    ElMessage.error("Á°ÆËÆ§Â§±Ë¥•");
  }
};
// Âçï‰∏™ÊãíÁªù
const batchReturnDevice = async (deviceId) => {
  if (!deviceId) {
    ElMessage.warning("ËØ∑ÈÄâÊã©ËÆæÂ§á");
    return;
  }

  try {
    // ÂêàÂπ∂Á°ÆËÆ§ÂíåËæìÂÖ•ÂéüÂõ†Âà∞‰∏Ä‰∏™ÂºπÁ™ó
    const { value: remark } = await ElMessageBox.prompt(
      "Á°ÆÂÆöË¶ÅÊãíÁªùÂõûÊî∂ËØ•ËÆæÂ§áÂêóÔºüÂ∞ÜÂàõÂª∫ÈÄÄË¥ßËÆ¢ÂçïÂ§ÑÁêÜËØ•ËÆæÂ§á„ÄÇ\nËØ∑ËæìÂÖ•ÊãíÁªùÂõûÊî∂ÂéüÂõ†Ôºö",
      "ÊãíÁªùÂõûÊî∂Á°ÆËÆ§",
      {
        confirmButtonText: "Á°ÆÂÆöÊãíÁªù",
        cancelButtonText: "ÂèñÊ∂à",
        type: "warning",
        inputPlaceholder: "ËØ∑ËæìÂÖ•ÊãíÁªùÂõûÊî∂ÂéüÂõ†",
      }
    );

   
    

    const loading = ElLoading.service({
      lock: true,
      text: "Ê≠£Âú®Â§ÑÁêÜ...",
      background: "rgba(0, 0, 0, 0.7)",
    });

    await apiBatchReturnDevices({
      ids: deviceId + "",
      remark: remark || "ÂïÜÊà∑ÊãíÁªùÂõûÊî∂",
    });
    loading.close();
    ElMessage.success("ÊãíÁªùÊàêÂäüÔºåÂ∑≤ÂàõÂª∫ÈÄÄË¥ßËÆ¢Âçï");
    getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
  } catch (error) {
    if (error === "cancel") return; // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
    console.error("ÊãíÁªùÂ§±Ë¥•:", error);
    // ElMessage.error('ÊãíÁªùÂ§±Ë¥•: ' + (error.message || 'Êú™Áü•ÈîôËØØ'))
  }
};

// ÊâπÈáèÁ°ÆËÆ§ËÆæÂ§á
const batchRecycleDevices = async (orderId) => {
  try {
    const selectedDeviceIds = selectedDevices.value[orderId].map(
      (device) => device.id
    );
    if (selectedDeviceIds.length === 0) {
      ElMessage.warning("ËØ∑ÈÄâÊã©ËÆæÂ§á");
      return;
    }

    // ÂºπÂá∫ËæìÂÖ•Â§áÊ≥®ÁöÑÂØπËØùÊ°Ü
    const { value: remark } = await ElMessageBox.prompt(
      "ËØ∑ËæìÂÖ•Êìç‰ΩúÂ§áÊ≥®",
      "ÊâπÈáèÁ°ÆËÆ§ËÆæÂ§á",
      {
        confirmButtonText: "Á°ÆËÆ§",
        cancelButtonText: "ÂèñÊ∂à",
        inputPlaceholder: "ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ",
      }
    );

    await apiBatchRecycleDevices({
      ids: selectedDeviceIds.join(","),
      remark: remark || "",
    });
    ElMessage.success("ÊâπÈáèÁ°ÆËÆ§ÊàêÂäü");
    await getList(pagination.value.page); // Âà∑Êñ∞ÂàóË°®Ôºå‰øùÊåÅÂΩìÂâçÈ°µ
  } catch (error) {
    if (error !== "cancel") {
      console.error("ÊâπÈáèÁ°ÆËÆ§Â§±Ë¥•Ôºö", error);
      ElMessage.error("ÊâπÈáèÁ°ÆËÆ§Â§±Ë¥•");
    }
  }
};

// ÊâπÈáèÊãíÁªùËÆæÂ§á
const batchReturnDevices = async (orderId) => {
  try {
    const selectedDeviceIds = selectedDevices.value[orderId].map(
      (device) => device.id
    );
    if (selectedDeviceIds.length === 0) {
      ElMessage.warning("ËØ∑ÈÄâÊã©ËÆæÂ§á");
      return;
    }

    // ÂêàÂπ∂Á°ÆËÆ§ÂíåËæìÂÖ•ÂéüÂõ†Âà∞‰∏Ä‰∏™ÂºπÁ™ó
    const { value: remark } = await ElMessageBox.prompt(
      `Á°ÆÂÆöË¶ÅÊãíÁªùÂõûÊî∂Â∑≤ÈÄâÊã©ÁöÑ ${selectedDeviceIds.length} Âè∞ËÆæÂ§áÂêóÔºüÂ∞ÜÂàõÂª∫ÈÄÄË¥ßËÆ¢ÂçïÂ§ÑÁêÜËøô‰∫õËÆæÂ§á„ÄÇ\nËØ∑ËæìÂÖ•ÊãíÁªùÂõûÊî∂ÂéüÂõ†Ôºö`,
      "ÊâπÈáèÊãíÁªùÂõûÊî∂Á°ÆËÆ§",
      {
        confirmButtonText: "Á°ÆÂÆöÊãíÁªù",
        cancelButtonText: "ÂèñÊ∂à",
        type: "warning",
        inputPlaceholder: "ËØ∑ËæìÂÖ•ÊãíÁªùÂõûÊî∂ÂéüÂõ†",
      }
    );

    const loading = ElLoading.service({
      lock: true,
      text: "Ê≠£Âú®Â§ÑÁêÜ...",
      background: "rgba(0, 0, 0, 0.7)",
    });

    await apiBatchReturnDevices({
      ids: selectedDeviceIds.join(","),
      remark: remark || "ÂïÜÊà∑ÊâπÈáèÊãíÁªùÂõûÊî∂",
    });

    loading.close();
    ElMessage.success("ÊâπÈáèÊãíÁªùÊàêÂäüÔºåÂ∑≤ÂàõÂª∫ÈÄÄË¥ßËÆ¢Âçï");
    await getList(); // Âà∑Êñ∞ÂàóË°®
  } catch (error) {
    if (error === "cancel") return; // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
    console.error("ÊâπÈáèÊãíÁªùÂ§±Ë¥•:", error);
    ElMessage.error("ÊâπÈáèÊãíÁªùÂ§±Ë¥•: " + (error.message || "Êú™Áü•ÈîôËØØ"));
  }
};

// Ë°®Ê†ºÂ±ïÂºÄ/ÊäòÂè†‰∫ã‰ª∂
const handleExpandChange = (row: any, expandedRows: any[]) => {
  // Êàë‰ª¨ÈúÄË¶Å‰ªé‰∏≠ÊèêÂèñ ID Êï∞ÁªÑ
  const expandedIds = expandedRows.map((expandedRow) => expandedRow.id);

  // ‰ΩøÁî®usePageStateÁöÑÊñπÊ≥ï‰øùÂ≠òÂ±ïÂºÄÁä∂ÊÄÅ
  setExpandedRows(expandedIds);
};

const deviceLogVisible = ref(false);
const deviceInfo = ref({});

// viewDetail
const viewDetail = async (row) => {
  // Áõ¥Êé•ÈÄöËøá getDevice Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
  try {
    const data = await getDevice(row.id);
    if (data.code !== 1) {
      ElMessage.error(data.msg || "Ëé∑ÂèñËÆæÂ§áËØ¶ÊÉÖÂ§±Ë¥•");
      return;
    }
    deviceDetailData.value = data.data;
    deviceLogVisible.value = true;
  } catch (error) {
    console.error("Ëé∑ÂèñËÆæÂ§áËØ¶ÊÉÖÂ§±Ë¥•:", error);
    ElMessage.error("Ëé∑ÂèñËÆæÂ§áËØ¶ÊÉÖÂ§±Ë¥•");
  }
};

// ‰ª£‰∏ãÂçïÁõ∏ÂÖ≥
const addOrderDialogVisible = ref(false);

// ÊòæÁ§∫‰ª£‰∏ãÂçïÂºπÁ™ó
const showAddOrderDialog = () => {
  addOrderDialogVisible.value = true;
};

// Â§ÑÁêÜ‰ª£‰∏ãÂçïÊàêÂäü
const handleAddOrderSuccess = async () => {
  // Âà∑Êñ∞ÂàóË°®
  await getList();
};

// È°µÈù¢Âä†ËΩΩ
onMounted(async () => {
  await loadStatusList();
  // ‰ΩøÁî®‰øùÂ≠òÁöÑÈ°µÁ†ÅËé∑ÂèñÊï∞ÊçÆ
  await getList(pagination.value.page);
});

// ËÆ°ÁÆóÂ±ûÊÄßÔºöËé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊî∂Ê¨æÊñπÂºè‰ø°ÊÅØ
const currentPaymentInfo = computed(() => {
  if (
    paymentInfo.value &&
    paymentInfo.value.length > 0 &&
    selectedPayTypeIndex.value >= 0 &&
    selectedPayTypeIndex.value < paymentInfo.value.length
  ) {
    return paymentInfo.value[selectedPayTypeIndex.value];
  }
  return null;
});

// tabÂàáÊç¢
const activeTab = ref("");
const handleTabClick = (tab: any) => {
  // Ê†πÊçÆtabÁöÑnameÂÄºËøõË°åÁ≠õÈÄâ
  activeTab.value = tab.props.name;
  quickSearchForm.status = tab.props.name;

  // Ê∏ÖÁ©∫È´òÁ∫ßÊêúÁ¥¢‰∏≠ÁöÑÁä∂ÊÄÅÁ≠õÈÄâÔºåÈÅøÂÖçÂÜ≤Á™Å
  advancedSearchForm.status = [];

  // ÈáçÊñ∞Ëé∑ÂèñÂàóË°®Êï∞ÊçÆÔºåÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  setPagination({ page: 1 });
  getList(1);
};

// Â§ÑÁêÜÊîØ‰ªòÁ°ÆËÆ§
const handlePaymentConfirm = async (paymentData) => {
  try {
    // Ë∞ÉÁî®Á°ÆËÆ§ÊâìÊ¨æAPI
    await paymentConfirm(paymentData.orderId, {
      pay_type: paymentData.payType,
      remark: "Ë¥¢Âä°Â∑≤Á°ÆËÆ§ÊâìÊ¨æ",
    });

    ElMessage.success("Á°ÆËÆ§ÊâìÊ¨æÊàêÂäü");
    paymentDialogVisible.value = false;

    // Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
    await getList();
  } catch (error) {
    console.error("Á°ÆËÆ§ÊâìÊ¨æÂ§±Ë¥•", error);
    ElMessage.error("Á°ÆËÆ§ÊâìÊ¨æÂ§±Ë¥•");
  }
};

// ËÆæÂ§áËØ¶ÊÉÖÂºπÁ™óÁõ∏ÂÖ≥
const deviceDetailData = ref(null);

// Â§ÑÁêÜËÆæÂ§áËØ¶ÊÉÖÂÖ≥Èó≠
const handleDeviceDetailClosed = () => {
  deviceDetailData.value = null;
};

// Â§ÑÁêÜËÆæÂ§áÁ°ÆËÆ§Êèê‰∫§
const handleDeviceConfirm = async (data: {
  orderId: number | string;
  devices: any[];
}) => {
  const loading = ElLoading.service({
    lock: true,
    text: "Ê≠£Âú®‰øùÂ≠ò...",
    background: "rgba(0, 0, 0, 0.7)",
  });

  try {
    // Êèê‰∫§ËÆæÂ§á‰ø°ÊÅØ
    const result = await updateRecycleOrder(data.orderId, {
      action: "order_sign",
      devices: data.devices.map((device) => ({
        id: device.id,
        imei: device.imei,
        model: device.model,
        initial_price: device.initial_price,
        category_id: device.category_id,
      })),
    });

    if (result.code !== 1) {
      loading.close();
      orderDialogVisible.value = false;
      throw new Error(result.message || "Êìç‰ΩúÂ§±Ë¥•");
    }

    ElMessage.success("ËÆ¢ÂçïÁ≠æÊî∂ÊàêÂäü");
    orderDialogVisible.value = false;
    await getList(); // Âà∑Êñ∞ÂàóË°®

    loading.close();
  } catch (error: any) {
    // console.error('‰øùÂ≠òËÆæÂ§á‰ø°ÊÅØÂ§±Ë¥•Ôºö', error)
    // orderDialogVisible.value = false
    loading.close();
    // ElMessage.error(error.message || '‰øùÂ≠òÂ§±Ë¥•')
  }
};

// Â§ÑÁêÜË¥®Ê£ÄÂõæÁâáÊï∞ÁªÑ
const checkImagesArray = computed(() => {
  if (!deviceInfo.value?.data?.check_images) return [];
  return deviceInfo.value.data.check_images.split(",").filter((url) => url);
});

// È¢ÑËßàÂõæÁâá
const previewImage = (url) => {
  img(url);
};

// Êü•ÁúãËÆ¢ÂçïËØ¶ÊÉÖ
const viewOrderDetail = (order: any) => {
  orderDetail.value = order;
  orderDetailVisible.value = true;
};

// ÊâìÂç∞ËÆæÂ§áÊ†áÁ≠æ
const printDeviceLabel = async (device: any) => {
  try {
    const loading = ElLoading.service({
      lock: true,
      text: "Ê≠£Âú®ÊâìÂç∞Ê†áÁ≠æ...",
      background: "rgba(0, 0, 0, 0.7)",
    });

    const res = await _printDeviceLabel(device.id);
    loading.close();

    if (res.code === 1) {
      ElMessage.success("Ê†áÁ≠æÊâìÂç∞ÊàêÂäü");
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊ®°ÊãüÊâìÂç∞
      if (res.data && res.data.simulated) {
        ElNotification({
          title: "Ê®°ÊãüÊâìÂç∞",
          message: "Â∑≤ÁîüÊàêÊâìÂç∞ÂÜÖÂÆπÔºå‰ΩÜÊú™ËøûÊé•ÂÆûÈôÖÊâìÂç∞Êú∫",
          type: "warning",
          duration: 5000,
        });
        // ÂºπÂá∫ÊâìÂç∞ÂÜÖÂÆπÈ¢ÑËßàÁ™óÂè£
        ElMessageBox.alert(
          `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${res.data.content}</pre>`,
          "ÊâìÂç∞ÂÜÖÂÆπÈ¢ÑËßà",
          {
            dangerouslyUseHTMLString: true,
            confirmButtonText: "ÂÖ≥Èó≠",
            callback: () => {},
          }
        );
      }
    } else {
      const errorMsg = res.message || "ÊâìÂç∞Â§±Ë¥•";
      const debugInfo = res.debug_info ? JSON.stringify(res.debug_info) : "";
      ElMessage.error(`${errorMsg} ${debugInfo}`);
      console.error("ÊâìÂç∞Â§±Ë¥•:", res);
    }
  } catch (error: any) {
    console.error("ÊâìÂç∞ËøáÁ®ãÂºÇÂ∏∏:", error);
    ElMessage.error(`ÊâìÂç∞ËøáÁ®ãÂºÇÂ∏∏: ${error.message || "Êú™Áü•ÈîôËØØ"}`);
  }
};

// Êü•ËØ¢Âø´ÈÄíÁöÑÁâ©ÊµÅ‰ø°ÊÅØ
const queryExpress = async (express_code: string, mobile: string) => {
  try {
    const res = await getExpress(express_code, mobile);
    return res.data;
  } catch (error) {
    console.error('Êü•ËØ¢Âø´ÈÄí‰ø°ÊÅØÂ§±Ë¥•:', error);
    throw error;
  }
};

// Â§ÑÁêÜÂø´ÈÄíÂçïÂè∑ÊÇ¨ÂÅú
const handleExpressHover = async (row: any) => {
  if (!row.express_no || row.express_no === 'ÊöÇÊó†') return;
  
  // Ê∏ÖÈô§‰πãÂâçÁöÑËÆ°Êó∂Âô®
  if (hoverTimer.value) {
    clearTimeout(hoverTimer.value);
  }
  
  // ËÆæÁΩÆÂª∂ËøüÊü•ËØ¢
  hoverTimer.value = setTimeout(async () => {
    try {
      // ËÆæÁΩÆloadingÁä∂ÊÄÅ
      expressLoading.value[row.id] = true;
      
      // Ëé∑ÂèñÁî®Êà∑ÊâãÊú∫Âè∑Âêé4‰Ωç
      const mobile = row.member?.mobile || row.recycleUserAddress?.mobile || '';
      const mobileLast4 = mobile.slice(-4);
      
      if (!mobileLast4) {
        ElMessage.warning('Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ÊâãÊú∫Âè∑ÔºåÊó†Ê≥ïÊü•ËØ¢Âø´ÈÄí‰ø°ÊÅØ');
        return;
      }
      
      // Êü•ËØ¢Âø´ÈÄí‰ø°ÊÅØ
      const expressData = await queryExpress(row.express_no, mobileLast4);
      
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÊúâÊïàÁöÑÂø´ÈÄíÊï∞ÊçÆ
      if (!expressData || !expressData.data || !expressData.data.logisticsTraceDetailList || expressData.data.logisticsTraceDetailList.length === 0) {
        ElMessage.info('ÊöÇÊó†Áâ©ÊµÅ‰ø°ÊÅØ');
        return;
      }
      
      // ËÆæÁΩÆÂø´ÈÄí‰ø°ÊÅØÂπ∂ÊòæÁ§∫ÂºπÂá∫Ê°Ü
      expressInfo.value = expressData.data;
      currentExpressRow.value = row;
      expressPopoverVisible.value = true;
      
    } catch (error) {
      console.error('Êü•ËØ¢Âø´ÈÄí‰ø°ÊÅØÂ§±Ë¥•:', error);
      ElMessage.error('Êü•ËØ¢Âø´ÈÄí‰ø°ÊÅØÂ§±Ë¥•');
    } finally {
      // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
      expressLoading.value[row.id] = false;
    }
  }, 500); // 500msÂª∂Ëøü
};

// Â§ÑÁêÜÈº†Ê†áÁ¶ªÂºÄ
const handleExpressLeave = () => {
  if (hoverTimer.value) {
    clearTimeout(hoverTimer.value);
    hoverTimer.value = null;
  }
};

// Ëé∑ÂèñÂø´ÈÄíÁä∂ÊÄÅÁ±ªÂûã
const getExpressStatusType = (status: string) => {
  switch (status) {
    case 'ACCEPT':
      return 'info';
    case 'TRANSPORT':
      return 'warning';
    case 'DELIVER':
      return 'primary';
    case 'SIGN':
      return 'success';
    case 'REJECT':
    case 'EXCEPTION':
      return 'danger';
    default:
      return 'info';
  }
};

// Ëé∑ÂèñÁä∂ÊÄÅÊèèËø∞
const getStatusDesc = (status: number) => {
  switch (status) {
    case 1:
      return "ÂæÖÁ≠æÊî∂";
    case 2:
      return "Ë¥®Ê£Ä‰∏≠";
    case 3:
      return "Â∑≤Ë¥®Ê£Ä";
    case 4:
      return "ÂæÖÂÆö‰ª∑";
    case 5:
      return "ÂæÖÁî®Êà∑Á°ÆËÆ§";
    case 6:
      return "ÂæÖË¥¢Âä°ÊâìÊ¨æ";
    case 7:
      return "Â∑≤ÊâìÊ¨æ|ÂÆåÊàê‚úÖ";
    case 8:
      return "Â∑≤ÂèñÊ∂à";
    case 9:
      return "Â∑≤ÂèñÊ∂à";
    case 10:
      return "Â∑≤Âà†Èô§";
    default:
      return "Êú™Áü•Áä∂ÊÄÅ";
  }
};

</script>

<style lang="scss" scoped>
.recycle-order-list {
  .el-card {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  :deep(.el-card__body) {
    flex: 1;
    overflow: auto;
  }
}

.recycle-order-list {
  .el-card {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  :deep(.el-card__body) {
    flex: 1;
    overflow: auto;
  }

  // ÊêúÁ¥¢Á≥ªÁªüÊ†∑ÂºèÂ∑≤ÂÖ®ÈÉ®‰ΩøÁî® Tailwind CSS Êõø‰ª£

  // Ê†áÁ≠æÈ°µÊ†∑Âºè
  .order-tabs {
    :deep(.el-tabs__header) {
      margin-bottom: 16px;
    }

    :deep(.el-tabs__nav-wrap) {
      &::after {
        background-color: #e4e7ed;
      }
    }

    :deep(.el-badge) {
      .el-badge__content {
        font-size: 11px;
        padding: 0 4px;
        height: 16px;
        line-height: 16px;
        min-width: 16px;
      }
    }
  }

  // Ë°®Ê†ºÊ†∑Âºè
  .order-table {
    :deep(.el-table__expanded-cell) {
      padding: 0 !important;
    }

    // ËÆ¢Âçï‰ø°ÊÅØÂçïÂÖÉÊ†º
    .order-info-cell {
      .info-row {
        display: flex;
        align-items: center;
        margin-bottom: 4px;

        &:last-child {
          margin-bottom: 0;
        }

        .label {
          color: #909399;
          font-size: 12px;
          min-width: 60px;
        }

        .value {
          color: #303133;
          font-size: 13px;
        }
      }
    }

    // Áî®Êà∑‰ø°ÊÅØÂçïÂÖÉÊ†º
    .user-info-cell {
      display: flex;
      align-items: center;

      .user-details {
        .user-name {
          font-weight: 500;
          color: #303133;
          font-size: 14px;
          margin-bottom: 2px;
        }

        .user-phone {
          color: #909399;
          font-size: 12px;
        }
      }
    }

    // ËÆæÂ§áÊï∞ÈáèÊ†áÁ≠æ
    .device-count-tag {
      font-weight: 500;
    }
  }

  // ËÆæÂ§áÂ±ïÂºÄÈù¢ÊùøÊ†∑Âºè
  .device-expansion-panel {
    padding: 20px;
    background-color: #fafbfc;
    border-radius: 6px;


    .panel-header {
      display: flex;
      justify-content: between;
      align-items: center;
      border-bottom: 1px solid #e4e7ed;
      padding-bottom: 12px;
    }

    .device-table {
      :deep(.el-table__header) {
        background-color: #f5f7fa;
      }

      :deep(.el-table) {
        border-radius: 4px;
        overflow: hidden;
      }
    }

    .price-text {
      color: #f56c6c;
      font-weight: 600;
      font-size: 14px;
    }
  }
}

.device-detail {
  padding: 0 10px;

  .detail-section {
    margin-bottom: 20px;
    border-bottom: 1px solid #ebeef5;
    padding-bottom: 15px;

    &:last-child {
      border-bottom: none;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #303133;
      position: relative;
      padding-left: 10px;

      &::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 16px;
        background-color: #409eff;
        border-radius: 2px;
      }
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;

      .info-item {
        display: flex;
        align-items: flex-start;

        &.full-width {
          grid-column: span 2;
        }

        .label {
          width: 80px;
          color: #606266;
          font-size: 14px;
        }

        .value {
          flex: 1;
          color: #303133;
          font-size: 14px;
          word-break: break-all;

          &.price {
            color: #f56c6c;
            font-weight: 500;
          }

          &.highlight {
            font-size: 16px;
            font-weight: bold;
          }
        }

        .status-tag {
          padding: 2px 8px;
          border-radius: 4px;
          font-size: 12px;

          &.status-1 {
            background-color: #e6f7ff;
            color: #1890ff;
          }

          &.status-2 {
            background-color: #fff7e6;
            color: #fa8c16;
          }

          &.status-3 {
            background-color: #f6ffed;
            color: #52c41a;
          }

          &.status-4 {
            background-color: #e6fffb;
            color: #13c2c2;
          }

          &.status-5 {
            background-color: #f9f0ff;
            color: #722ed1;
          }

          &.status-6 {
            background-color: #fff1f0;
            color: #f5222d;
          }
        }
      }
    }

    .check-images {
      margin-top: 15px;

      h4 {
        font-size: 14px;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .image-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;

        :deep(.el-image) {
          width: 80px;
          height: 80px;
          border-radius: 4px;
          cursor: pointer;
          border: 1px solid #ebeef5;
          transition: all 0.3s;

          &:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
          }
        }
      }
    }

    .remark-content {
      padding: 10px;
      background-color: #f5f7fa;
      border-radius: 4px;
      color: #606266;
      min-height: 40px;
    }
  }
}

.empty-data {
  padding: 30px 0;
}

/* ‰ª£‰∏ãÂçïÁõ∏ÂÖ≥Ê†∑Âºè */
.user-info {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

.user-info div {
  padding: 5px 0;
}

.search-results {
  max-height: 300px;
  overflow-y: auto;
}

.order-info ol {
  padding-left: 20px;
  margin-top: 5px;
  margin-bottom: 0;
}

.order-info p {
  margin-bottom: 5px;
}

/* ÊêúÁ¥¢Á≥ªÁªüÂÆåÂÖ®‰ΩøÁî® Tailwind CSS ÈáçÊûÑÔºåÂà†Èô§ÊóßÊ†∑Âºè */
</style>


<style scoped>
.express-no-container {
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 4px;
  padding: 2px 4px;
}

.express-no-container:hover {
  background-color: #f5f7fa;
  color: #409eff;
}

.express-no {
  font-family: 'Courier New', monospace;
  font-weight: 500;
}

.express-loading {
  color: #409eff;
}

.express-icon {
  color: #909399;
  font-size: 12px;
}

.express-info-container {
  max-height: 500px;
  overflow-y: auto;
}

.express-header {
  border-bottom: 1px solid #ebeef5;
  padding-bottom: 16px;
}


.trace-item  .trace-location {
    font-weight: 500;
    color: #303133;
    margin-bottom: 4px;
  }
  
.trace-item   .trace-desc {
    color: #606266;
    font-size: 14px;
    line-height: 1.5;
  }

</style>

